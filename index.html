<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Excavator Work Timer</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: direction 0.3s ease;
        }
        body[dir="rtl"] {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .timer-display { text-align: center; margin-bottom: 20px; }
        .timer-display .time {
            font-size: 64px;
            font-weight: bold;
            color: #2563eb;
            font-variant-numeric: tabular-nums;
        }
        .payment-display {
            text-align: center;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        .payment-display .amount {
            font-size: 48px;
            font-weight: bold;
            color: white;
        }
        .job-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .job-info .job-name {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        .btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        .btn-start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            margin-bottom: 15px;
        }
        .btn-pause {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #475569;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .tab.active {
            background: white;
            color: #2563eb;
        }
        .view { display: none; }
        .view.active { display: block; }
        .today-summary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .summary-item { text-align: center; }
        .summary-item .value {
            font-size: 32px;
            font-weight: bold;
        }
        .saved-job-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .saved-job-item:hover {
            background: #e2e8f0;
        }
        .saved-job-item.selected {
            background: #dbeafe;
            border: 2px solid #2563eb;
        }
        .history-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2563eb;
            position: relative;
        }
        .delete-history-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .delete-history-btn:hover {
            background: #fca5a5;
        }
        @media (max-width: 480px) {
            .timer-display .time { font-size: 48px; }
            .payment-display .amount { font-size: 36px; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="app_title">üöú Excavator Timer</h1>
            <p data-i18n="app_subtitle">Track your work time & earnings</p>
            <button onclick="toggleLanguage()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; margin-top: 10px; font-size: 14px;">
                üåê <span id="lang-toggle">AR</span>
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('timer')" data-i18n="tab_timer">Live Timer</button>
            <button class="tab" onclick="switchTab('manual')" data-i18n="tab_manual">Manual Entry</button>
            <button class="tab" onclick="switchTab('history')" data-i18n="tab_history">History</button>
            <button class="tab" onclick="switchTab('expenses')" data-i18n="tab_expenses">üí∞ Expenses</button>
            <button class="tab" onclick="switchTab('settings')" data-i18n="tab_settings">Settings</button>
        </div>

        <div id="timer-view" class="view active">
            <div class="card">
                <div id="setup-section">
                    <h2 style="margin-bottom: 20px;" data-i18n="select_job">Create Job</h2>
                    <div class="input-group">
                        <label data-i18n="job_site">üìç Job Site</label>
                        <input type="text" id="job-site" placeholder="e.g., Casa Marina Beach">
                    </div>
                    <div class="input-group">
                        <label data-i18n="client_name">üë§ Client Name</label>
                        <input type="text" id="client-name" placeholder="e.g., Ahmed">
                    </div>
                    <div class="input-group">
                        <label data-i18n="hourly_rate">üí∞ Hourly Rate (MAD)</label>
                        <input type="number" id="hourly-rate" placeholder="e.g., 500">
                    </div>
                    <button class="btn btn-start" onclick="startTimer()" data-i18n="start_working">Start Working</button>
                </div>

                <div id="timer-section" style="display: none;">
                    <div class="job-info">
                        <div style="font-size: 14px; color: #64748b; margin-bottom: 5px;">üìç <span id="current-job-site">-</span></div>
                        <div class="job-name">üë§ <span id="current-client-name">-</span></div>
                        <div style="color: #64748b; margin-top: 5px;">Rate: <strong id="current-rate" style="color: #2563eb;">0</strong> MAD/hour</div>
                    </div>
                    <div class="timer-display">
                        <div class="time" id="timer">00:00:00</div>
                    </div>
                    <div class="payment-display">
                        <div class="amount" id="payment">0.00 MAD</div>
                    </div>
                    <button class="btn btn-stop" onclick="stopTimer()" data-i18n="stop_save">Stop & Save</button>
                    <button class="btn btn-pause" onclick="pauseTimer()" id="pause-btn" data-i18n="pause">Pause</button>
                </div>
            </div>

            <div class="card today-summary">
                <h3 data-i18n="today_summary">üìä Today's Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="value" id="today-hours">0h 0m</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_time">Total Time</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="today-payment">0 MAD</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_payment">Total Earned</div>
                    </div>
                </div>
            </div>

            <div class="card today-summary" style="margin-top: 15px;">
                <h3 data-i18n="total_all_summary">üìà Total ALL Sessions</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="value" id="total-hours">0h 0m</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_time">Total Time</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="total-payment">0 MAD</div>
                        <div style="font-size: 12px; opacity: 0.8;" data-i18n="total_payment">Total Payment</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manual-view" class="view">
            <div class="card">
                <h2 style="margin-bottom: 20px;" data-i18n="manual_entry_title">üìù Manual Time Entry</h2>
                <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;" data-i18n="manual_entry_desc">Enter start and stop times to calculate work duration and payment</p>
                
                <!-- Toggle buttons for entry method -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="manual-method-time-range" onclick="switchManualMethod('time-range')" style="flex: 1; padding: 12px; border: 2px solid #2563eb; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #2563eb; color: white;">
                        üïê <span data-i18n="time_range_entry">Time Range</span>
                    </button>
                    <button id="manual-method-duration" onclick="switchManualMethod('duration')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">
                        ‚è±Ô∏è <span data-i18n="duration_entry">Duration Entry</span>
                    </button>
                </div>
                
                <!-- Common fields (both methods) -->
                <div class="input-group">
                    <label data-i18n="job_site">üìç Job Site</label>
                    <input type="text" id="manual-job-site" placeholder="e.g., Casa Marina Beach">
                </div>

                <div class="input-group">
                    <label data-i18n="client_name">üë§ Client Name</label>
                    <input type="text" id="manual-client-name" placeholder="e.g., Ahmed">
                </div>

                <div class="input-group">
                    <label>üìÖ <span data-i18n="work_date">Work Date</span></label>
                    <input type="date" id="manual-work-date" style="padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; width: 100%;">
                </div>

                <div class="input-group">
                    <label data-i18n="hourly_rate">üí∞ Hourly Rate (MAD)</label>
                    <input type="number" id="manual-hourly-rate" placeholder="e.g., 500">
                </div>

                <!-- Time Range Method Fields -->
                <div id="time-range-fields">
                    <div class="input-group">
                        <label data-i18n="start_time">Start Time (24-hour format: HH:MM)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="manual-start-time" placeholder="08:30" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1;">
                            <select id="manual-start-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                                <option value="AM" data-i18n="morning">Morning (AM)</option>
                                <option value="PM" data-i18n="evening">Evening (PM)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label data-i18n="stop_time">Stop Time (24-hour format: HH:MM)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="manual-stop-time" placeholder="17:00" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1;">
                            <select id="manual-stop-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                                <option value="AM" data-i18n="morning">Morning (AM)</option>
                                <option value="PM" data-i18n="evening">Evening (PM)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Duration Entry Method Fields (hidden by default) -->
                <div id="duration-fields" style="display: none;">
                    <div class="input-group">
                        <label>‚è±Ô∏è <span data-i18n="work_hours">Work Hours</span></label>
                        <input type="number" id="manual-duration-hours" placeholder="e.g., 5" min="0" max="23">
                    </div>

                    <div class="input-group">
                        <label>‚è±Ô∏è <span data-i18n="work_minutes">Work Minutes</span></label>
                        <input type="number" id="manual-duration-minutes" placeholder="e.g., 30" min="0" max="59">
                    </div>
                </div>

                <div id="manual-result" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: #166534; margin-bottom: 10px;" data-i18n="duration_payment">Duration & Payment</div>
                        <div style="font-size: 32px; font-weight: bold; color: #15803d;" id="manual-duration">0h 0m</div>
                        <div style="font-size: 36px; font-weight: bold; color: #15803d; margin-top: 10px;" id="manual-payment">0.00 MAD</div>
                    </div>
                </div>

                <button class="btn btn-start" onclick="calculateManual()" data-i18n="calculate">Calculate</button>
                <button class="btn" style="background: #e2e8f0; color: #475569; margin-top: 10px;" onclick="saveManual()" data-i18n="save_history">Save to History</button>
            </div>
        </div>

        <div id="history-view" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 data-i18n="work_history">Work History</h2>
                    <button class="btn" style="background: #f59e0b; color: white; padding: 12px 20px; width: auto; font-size: 14px;" onclick="clearUnsentSessions()" data-i18n="clear_unsent_sessions">üóëÔ∏è Clear Unsent Sessions</button>
                </div>
                <div id="history-list">
                    <p style="text-align: center; color: #94a3b8; padding: 40px;" data-i18n="no_history">No history yet</p>
                </div>
            </div>
        </div>

        <div id="settings-view" class="view">
            <div class="card">
                <h2 style="margin-bottom: 20px;" data-i18n="worker_settings">‚öôÔ∏è Worker Settings</h2>
                
                <div class="input-group">
                    <label data-i18n="your_name">Your Name</label>
                    <input type="text" id="worker-name" placeholder="Enter your name">
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;" data-i18n="name_appears">This name will appear in admin reports</p>
                </div>

                <button class="btn btn-start" onclick="saveWorkerName()" data-i18n="save_name">Save Name</button>

                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 10px; border: 2px solid #cbd5e1;">
                    <h3 style="color: #475569; margin-bottom: 15px;">üïê <span data-i18n="time_format">Time Format</span></h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="time-format-24h" onclick="setTimeFormat('24h')" style="flex: 1; padding: 12px; border: 2px solid #2563eb; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #2563eb; color: white;">
                            <span data-i18n="time_format_24h">24-hour (14:30)</span>
                        </button>
                        <button id="time-format-12h" onclick="setTimeFormat('12h')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">
                            <span data-i18n="time_format_12h">12-hour (2:30 PM)</span>
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f0fdf4; border-radius: 10px; border: 2px solid #22c55e;">
                    <h3 style="color: #166534; margin-bottom: 10px;" data-i18n="submit_sessions">üì§ Submit Work Sessions</h3>
                    <p style="font-size: 14px; color: #166534; margin-bottom: 15px;" data-i18n="send_unsent">Send unsent work sessions to admin</p>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #166534;" data-i18n="unsent_sessions">Unsent Sessions:</strong>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 8px;">
                            <div id="submit-summary"></div>
                        </div>
                    </div>
                    <button class="btn btn-start" onclick="submitToAdmin()" data-i18n="submit_admin">Submit to Admin</button>
                </div>

                <div id="submission-history" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1e293b; margin: 0;" data-i18n="submission_history">üìã Submission History</h3>
                        <div style="font-size: 12px; color: #64748b; font-style: italic;">‚ÑπÔ∏è Admin can delete completed submissions</div>
                    </div>
                    
                    <!-- Toggle Tabs: Active vs Completed -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="submission-tab-active" onclick="switchSubmissionTab('active')" style="flex: 1; padding: 12px; border: 2px solid #2563eb; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #2563eb; color: white;">
                            üìä <span data-i18n="active_submissions">Active</span> (<span id="active-count">0</span>)
                        </button>
                        <button id="submission-tab-completed" onclick="switchSubmissionTab('completed')" style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">
                            ‚úÖ <span data-i18n="completed_submissions">Completed</span> (<span id="completed-count">0</span>)
                        </button>
                    </div>
                    
                    <div id="submission-list"></div>
                </div>
            </div>
        </div>

        <div id="expenses-view" class="view">
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <div style="background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;" data-i18n="exp_today">Today</div>
                    <div style="font-size: 20px; font-weight: bold; color: #dc2626;" id="expenses-today">0 MAD</div>
                </div>
                <div style="background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;" data-i18n="exp_week">This Week</div>
                    <div style="font-size: 20px; font-weight: bold; color: #dc2626;" id="expenses-week">0 MAD</div>
                </div>
                <div style="background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="font-size: 11px; color: #64748b; margin-bottom: 5px;" data-i18n="exp_month">This Month</div>
                    <div style="font-size: 20px; font-weight: bold; color: #dc2626;" id="expenses-month">0 MAD</div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;" data-i18n="exp_add_new">üí∞ Add New Expense</h2>
                
                <!-- Expense Type Buttons -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px;">
                    <button onclick="openExpenseModal('repair')" style="padding: 20px; border: 2px solid #ef4444; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 28px; margin-bottom: 5px;">üîß</div>
                        <div style="font-size: 13px; font-weight: 600; color: #1e293b;" data-i18n="exp_repair">Repair</div>
                    </button>
                    <button onclick="openExpenseModal('fuel')" style="padding: 20px; border: 2px solid #f59e0b; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 28px; margin-bottom: 5px;">‚õΩ</div>
                        <div style="font-size: 13px; font-weight: 600; color: #1e293b;" data-i18n="exp_fuel">Fuel</div>
                    </button>
                    <button onclick="openExpenseModal('parts')" style="padding: 20px; border: 2px solid #8b5cf6; background: white; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 28px; margin-bottom: 5px;">‚öôÔ∏è</div>
                        <div style="font-size: 13px; font-weight: 600; color: #1e293b;" data-i18n="exp_parts">Parts</div>
                    </button>
                </div>

                <!-- Unsent Expenses Section -->
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #92400e; margin: 0;" data-i18n="exp_unsent">üìù Unsent Expenses</h3>
                        <span id="unsent-count-badge" style="background: #fbbf24; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="unsent-expenses-list">
                        <p style="text-align: center; color: #92400e; font-size: 13px;" data-i18n="exp_no_unsent">No unsent expenses</p>
                    </div>
                    <button id="submit-expenses-btn" onclick="submitExpenses()" style="width: 100%; padding: 15px; border: none; background: #10b981; color: white; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 15px; display: none;" data-i18n="exp_submit_all">
                        üì§ Submit All Expenses
                    </button>
                </div>

                <!-- Submitted Expenses History -->
                <div style="margin-top: 20px;">
                    <h3 style="color: #1e293b; margin-bottom: 15px;" data-i18n="exp_submitted_history">üìã Submitted Expenses History</h3>
                    
                    <!-- Filter Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="expense-filter-btn active" onclick="filterSubmittedExpenses('today')" style="padding: 8px 16px; border: 2px solid #2563eb; background: #2563eb; color: white; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            <span data-i18n="exp_filter_today">Today</span>
                        </button>
                        <button class="expense-filter-btn" onclick="filterSubmittedExpenses('week')" style="padding: 8px 16px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            <span data-i18n="exp_filter_week">This Week</span>
                        </button>
                        <button class="expense-filter-btn" onclick="filterSubmittedExpenses('month')" style="padding: 8px 16px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            <span data-i18n="exp_filter_month">This Month</span>
                        </button>
                        <button class="expense-filter-btn" onclick="filterSubmittedExpenses('all')" style="padding: 8px 16px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            <span data-i18n="exp_filter_all">All</span>
                        </button>
                    </div>
                    
                    <div id="submitted-expenses-list">
                        <p style="text-align: center; color: #94a3b8; padding: 20px;" data-i18n="exp_no_submitted">No submitted expenses yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;" data-i18n="add_payment">üí∞ Add Payment</h2>
            
            <div id="paymentModalInfo" style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; color: #64748b;">
            </div>
            
            <div class="input-group">
                <label for="paymentAmount" data-i18n="payment_amount">Payment Amount (MAD)</label>
                <input type="number" id="paymentAmount" placeholder="Enter amount received" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div id="markFullyPaidSection" style="display: none; margin-top: 15px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; color: #92400e;">
                    <input type="checkbox" id="markFullyPaidCheckbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span>
                        <strong data-i18n="mark_fully_paid">Mark as fully paid</strong><br>
                        <span style="font-size: 12px; color: #b45309;" data-i18n="client_cannot_pay_more">(Client cannot pay the remaining amount)</span>
                    </span>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closePaymentModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="addPayment()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white;" data-i18n="add_payment">Add Payment</button>
            </div>
        </div>
    </div>

    <!-- Expense Modals -->
    <!-- Repair Modal -->
    <div id="repairModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;">üîß <span data-i18n="exp_add_repair">Add Repair Expense</span></h2>
            
            <div class="input-group">
                <label data-i18n="exp_date">üìÖ Date</label>
                <input type="date" id="repair-date" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_amount">üí∞ Amount (MAD)</label>
                <input type="number" id="repair-amount" placeholder="Enter repair cost" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_description">üìù Description</label>
                <textarea id="repair-description" placeholder="What was repaired?" rows="3" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeExpenseModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="saveExpense('repair')" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #ef4444; color: white;" data-i18n="exp_save">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Fuel Modal -->
    <div id="fuelModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;">‚õΩ <span data-i18n="exp_add_fuel">Add Fuel Expense</span></h2>
            
            <div class="input-group">
                <label data-i18n="exp_date">üìÖ Date</label>
                <input type="date" id="fuel-date" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_total_amount">üí∞ Total Amount (MAD)</label>
                <input type="number" id="fuel-total-amount" placeholder="e.g., 500" step="0.01" min="0" oninput="calculateFuelFromTotal()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_liters">‚õΩ Liters</label>
                <input type="number" id="fuel-liters" placeholder="e.g., 50" step="0.1" min="0" oninput="calculateFuelBidirectional()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_price_per_liter">üí∞ Price per Liter (MAD)</label>
                <input type="number" id="fuel-price-per-liter" placeholder="e.g., 12.50" step="0.01" min="0" oninput="calculateFuelFromPrice()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_description">üìù Description (Optional)</label>
                <textarea id="fuel-description" placeholder="Any notes..." rows="2" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeExpenseModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="saveExpense('fuel')" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #f59e0b; color: white;" data-i18n="exp_save">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Parts Modal -->
    <div id="partsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;">‚öôÔ∏è <span data-i18n="exp_add_parts">Add Parts Expense</span></h2>
            
            <div class="input-group">
                <label data-i18n="exp_date">üìÖ Date</label>
                <input type="date" id="parts-date" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_part_name">üî© Part Name</label>
                <input type="text" id="parts-name" placeholder="e.g., Hydraulic Filter" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_price">üí∞ Price (MAD)</label>
                <input type="number" id="parts-price" placeholder="Enter part price" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="exp_notes">üìù Notes (Optional)</label>
                <textarea id="parts-notes" placeholder="Any additional notes..." rows="2" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeExpenseModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="saveExpense('parts')" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #8b5cf6; color: white;" data-i18n="exp_save">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editExpenseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px;">
            <h2 style="margin-bottom: 20px; color: #1e293b;">‚úèÔ∏è <span data-i18n="exp_edit">Edit Expense</span></h2>
            <div id="editExpenseContent"></div>
        </div>
    </div>

    <!-- Device Registration Screen -->
    <div id="registrationScreen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
            <div style="font-size: 64px; margin-bottom: 20px;">üîê</div>
            <h2 style="font-size: 24px; color: #1e293b; margin-bottom: 10px;" data-i18n="device_registration">Device Registration</h2>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 30px; line-height: 1.6;">
                <span data-i18n="registration_desc">Enter your registration code to access the app. Contact your admin if you don't have a code.</span>
            </p>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="registrationCodeInput" placeholder="Enter registration code" 
                    style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; text-align: center; text-transform: uppercase; font-family: monospace; letter-spacing: 2px;">
            </div>
            
            <div id="registrationError" style="display: none; background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>
            
            <button id="registerDeviceBtn" onclick="registerDevice()" 
                style="width: 100%; padding: 18px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; transition: transform 0.2s;">
                <span data-i18n="register_device">Register This Device</span>
            </button>
            
            <div id="registrationLoading" style="display: none; margin-top: 20px; color: #64748b; font-size: 14px;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="margin-left: 10px;">Registering device...</span>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div id="customAlertIcon" style="text-align: center; font-size: 48px; margin-bottom: 15px;">‚ÑπÔ∏è</div>
            <div id="customAlertMessage" style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap;"></div>
            <button id="customAlertOkBtn" style="width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div id="customConfirmIcon" style="text-align: center; font-size: 48px; margin-bottom: 15px;">‚ùì</div>
            <div id="customConfirmMessage" style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap;"></div>
            <div style="display: flex; gap: 10px;">
                <button id="customConfirmCancelBtn" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">Cancel</button>
                <button id="customConfirmOkBtn" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">OK</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #1e293b; text-align: center;">‚úèÔ∏è <span data-i18n="edit_session">Edit Session</span></h2>
            
            <div class="input-group">
                <label data-i18n="job_site">üìç Job Site</label>
                <input type="text" id="edit-job-site" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="client_name">üë§ Client Name</label>
                <input type="text" id="edit-client-name" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="hourly_rate">üí∞ Hourly Rate (MAD)</label>
                <input type="number" id="edit-hourly-rate" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div class="input-group">
                <label data-i18n="start_time">üïê Start Time (24h format: HH:MM)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="edit-start-time" placeholder="08:30" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    <select id="edit-start-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="AM" data-i18n="morning">Morning (AM)</option>
                        <option value="PM" data-i18n="evening">Evening (PM)</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label data-i18n="stop_time">üïê Stop Time (24h format: HH:MM)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="edit-stop-time" placeholder="17:00" pattern="[0-2][0-9]:[0-5][0-9]" maxlength="5" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    <select id="edit-stop-period" style="display: none; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                        <option value="AM" data-i18n="morning">Morning (AM)</option>
                        <option value="PM" data-i18n="evening">Evening (PM)</option>
                    </select>
                </div>
            </div>
            
            <div id="edit-calculated-result" style="display: none; background: #f0fdf4; border: 2px solid #22c55e; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 14px; color: #166534; margin-bottom: 5px;">Duration & Payment</div>
                <div style="font-size: 24px; font-weight: bold; color: #15803d;" id="edit-duration-display">0h 0m</div>
                <div style="font-size: 28px; font-weight: bold; color: #15803d; margin-top: 5px;" id="edit-payment-display">0 MAD</div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closeEditSessionModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="saveEditedSession()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" data-i18n="save_changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Price Adjustment Modal -->
    <div id="priceAdjustModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 450px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #1e293b; text-align: center;">üí∞ <span data-i18n="adjust_price">Adjust Price</span></h2>
            
            <div id="priceAdjustInfo" style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; color: #64748b;">
            </div>
            
            <div class="input-group">
                <label data-i18n="adjusted_price">Adjusted Price (MAD)</label>
                <input type="number" id="adjustedPriceInput" placeholder="Enter new price" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="closePriceAdjustModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;" data-i18n="cancel">Cancel</button>
                <button onclick="resetPrice()" style="flex: 1; padding: 15px; border: 2px solid #f59e0b; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #f59e0b;" data-i18n="reset_price">Reset</button>
                <button onclick="applyPriceAdjustment()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" data-i18n="apply_discount">Apply</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDR2jvmeJyD3pLoGZiRQ6CXqy86zVZeB3o",
            authDomain: "excavator-timer.firebaseapp.com",
            databaseURL: "https://excavator-timer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "excavator-timer",
            storageBucket: "excavator-timer.firebasestorage.app",
            messagingSenderId: "983543822117",
            appId: "1:983543822117:web:b55c1a232ef0fb96f8cccc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase accessible globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseGet = get;
        window.firebaseRemove = remove;
        window.firebaseAuth = auth;

        console.log('üî• Firebase initialized in worker app!');
        console.log('üì± Worker App Version: 6.0.0 (FIX: Work dates now display correctly, DD/MM/YYYY format, Delete expenses, Parts notes visible)');
        console.log('üïê Loaded at:', new Date().toLocaleString());

        // ========================================
        // üîê AUTHENTICATION & DEVICE REGISTRATION
        // ========================================
        
        let currentUser = null;
        let isDeviceRegistered = false;

        // Check if device is registered (stored locally)
        function checkDeviceRegistration() {
            const deviceId = localStorage.getItem('deviceId');
            const deviceRole = localStorage.getItem('deviceRole');
            
            console.log('üîç Checking device registration:', { deviceId, deviceRole });
            
            if (deviceId && deviceRole) {
                return { deviceId, deviceRole };
            }
            return null;
        }

        // Show/hide registration screen
        function showRegistrationScreen() {
            document.getElementById('registrationScreen').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
        }

        function hideRegistrationScreen() {
            document.getElementById('registrationScreen').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        // ========================================
        // üîë STABLE DEVICE FINGERPRINTING
        // ========================================
        // Generate a stable device ID based on browser fingerprint
        async function generateStableDeviceId() {
            // Collect browser characteristics
            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown'
            };
            
            // Create a consistent string from fingerprint
            const fingerprintString = JSON.stringify(fingerprint);
            
            // Generate stable hash using crypto API
            const encoder = new TextEncoder();
            const data = encoder.encode(fingerprintString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            console.log('üîë Generated stable device ID:', hashHex.substring(0, 20));
            return hashHex; // Returns same ID for same browser every time!
        }

        // Check if device is already registered in Firebase
        async function checkExistingDevice() {
            try {
                console.log('üîç Checking if device is already registered...');
                const stableDeviceId = await generateStableDeviceId();
                
                // Check in registeredDevices
                const deviceRef = ref(database, 'registeredDevices/' + stableDeviceId);
                const deviceSnapshot = await get(deviceRef);
                
                if (deviceSnapshot.exists()) {
                    const deviceData = deviceSnapshot.val();
                    console.log('‚úÖ Device already registered:', deviceData);
                    
                    if (deviceData.role === 'worker' && deviceData.workerName) {
                        // Device is already registered - load data and skip registration
                        localStorage.setItem('deviceId', stableDeviceId);
                        localStorage.setItem('deviceRole', 'worker');
                        localStorage.setItem('workerName', deviceData.workerName);
                        
                        // Update last active time
                        await update(deviceRef, { lastActive: Date.now() });
                        
                        // Load worker data from Firebase
                        await loadWorkerDataFromFirebase(deviceData.workerName);
                        
                        console.log('‚úÖ Auto-loaded existing device registration for:', deviceData.workerName);
                        return true; // Device already registered
                    }
                }
                
                console.log('‚ÑπÔ∏è Device not registered yet');
                return false; // Device not registered
            } catch (error) {
                console.error('‚ùå Error checking existing device:', error);
                return false;
            }
        }

        // Register device with code
        window.registerDevice = async function() {
            console.log('üîµ [1] registerDevice() called');
            const codeInput = document.getElementById('registrationCodeInput');
            const code = codeInput.value.trim().toUpperCase();
            const errorDiv = document.getElementById('registrationError');
            const loadingDiv = document.getElementById('registrationLoading');
            const registerBtn = document.getElementById('registerDeviceBtn');
            
            console.log('üîµ [2] Code entered:', code);
            
            if (!code) {
                errorDiv.textContent = 'Please enter a registration code';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Show loading
            loadingDiv.style.display = 'block';
            registerBtn.disabled = true;
            errorDiv.style.display = 'none';
            
            console.log('üîµ [3] Loading indicator shown, checking Firebase...');
            
            try {
                // Check if code exists and is valid
                const codeRef = ref(database, 'registrationCodes/' + code);
                console.log('üîµ [4] Fetching code from Firebase...');
                const codeSnapshot = await get(codeRef);
                console.log('üîµ [5] Code snapshot received:', codeSnapshot.exists());
                
                if (!codeSnapshot.exists()) {
                    throw new Error('Invalid registration code');
                }
                
                const codeData = codeSnapshot.val();
                console.log('üîµ [6] Code data:', codeData);
                
                // Check if code is for worker role
                if (codeData.type !== 'worker') {
                    throw new Error('This code is not valid for worker app');
                }
                
                // Get worker name from registration code
                const workerName = codeData.workerName || null;
                console.log('üîµ [7] Worker name from code:', workerName);
                
                // Generate stable device ID based on browser fingerprint
                const deviceId = await generateStableDeviceId();
                console.log('üîµ [8] Stable Device ID:', deviceId.substring(0, 20));
                
                // If worker name exists in code, ask for confirmation
                if (workerName) {
                    console.log('üîµ [9] Showing confirmation for existing worker...');
                    const confirmMsg = `This code is registered to: ${workerName}\n\nRegister this device for ${workerName}?`;
                    const confirmed = await customConfirm(confirmMsg, 'üë∑');
                    console.log('üîµ [10] Confirmation result:', confirmed);
                    
                    if (!confirmed) {
                        loadingDiv.style.display = 'none';
                        registerBtn.disabled = false;
                        return;
                    }
                    
                    console.log(`‚úÖ Registering device for existing worker: ${workerName}`);
                } else {
                    // First time registration - ask for worker name
                    console.log('üîµ [11] No worker name found, asking for name...');
                    const newWorkerName = await customPrompt('Please enter your name:', 'üë∑');
                    console.log('üîµ [12] Name entered:', newWorkerName);
                    if (!newWorkerName || !newWorkerName.trim()) {
                        loadingDiv.style.display = 'none';
                        registerBtn.disabled = false;
                        throw new Error('Worker name is required');
                    }
                    
                    // Save worker name to registration code
                    await update(codeRef, {
                        workerName: newWorkerName.trim(),
                        firstUsedAt: Date.now()
                    });
                    
                    console.log(`‚úÖ First time registration for worker: ${newWorkerName.trim()}`);
                }
                
                const finalWorkerName = workerName || (await get(codeRef)).val().workerName;
                
                // Register device in Firebase (linked to worker)
                const deviceRef = ref(database, 'registeredDevices/' + deviceId);
                await set(deviceRef, {
                    role: 'worker',
                    workerName: finalWorkerName,
                    registeredAt: Date.now(),
                    lastActive: Date.now(),
                    registrationCode: code,
                    deviceInfo: navigator.userAgent
                });
                
                // Add device to worker's device list
                const workerDevicesRef = ref(database, `workers/${finalWorkerName}/devices/${deviceId}`);
                await set(workerDevicesRef, {
                    deviceId: deviceId,
                    registeredAt: Date.now(),
                    lastActive: Date.now()
                });
                
                // Save to localStorage
                localStorage.setItem('deviceId', deviceId);
                localStorage.setItem('deviceRole', 'worker');
                localStorage.setItem('workerName', finalWorkerName);
                
                console.log('‚úÖ Device registered successfully!', { deviceId, role: 'worker', workerName: finalWorkerName });
                
                // Load existing worker data from Firebase
                await loadWorkerDataFromFirebase(finalWorkerName);
                
                // Hide registration screen and show app
                hideRegistrationScreen();
                await customAlert(`‚úÖ Welcome back, ${finalWorkerName}!\n\nDevice registered successfully!`, 'üéâ');
                
                // Initialize app
                initApp();
                
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                errorDiv.textContent = error.message || 'Registration failed. Please try again.';
                errorDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
                registerBtn.disabled = false;
            }
        };
        
        // Load existing worker data from Firebase on new device registration
        async function loadWorkerDataFromFirebase(workerName) {
            try {
                console.log(`üì• Loading existing data for worker: ${workerName}`);
                
                // Initialize data structure
                let data = loadData();
                data.workerName = workerName;
                
                // Ensure arrays exist
                if (!data.history) data.history = [];
                if (!data.submissions) data.submissions = [];
                if (!data.jobs) data.jobs = [];
                
                // Load drafts (unsent sessions)
                const draftsRef = ref(database, `drafts_v2/${workerName}`);
                const draftsSnapshot = await get(draftsRef);
                
                if (draftsSnapshot.exists()) {
                    const firebaseDrafts = draftsSnapshot.val();
                    const draftsArray = Object.values(firebaseDrafts);
                    
                    console.log(`üì¶ Found ${draftsArray.length} unsent sessions in Firebase`);
                    
                    // Merge with local history (avoid duplicates)
                    const existingTimestamps = data.history.map(h => h.timestamp);
                    draftsArray.forEach(draft => {
                        if (!existingTimestamps.includes(draft.timestamp)) {
                            data.history.push(draft);
                        }
                    });
                }
                
                // Load submissions (sent sessions) - we need to check submissions in Firebase
                const submissionsRef = ref(database, 'submissions_v2');
                const submissionsSnapshot = await get(submissionsRef);
                
                if (submissionsSnapshot.exists()) {
                    const allSubmissions = submissionsSnapshot.val();
                    const workerSubmissions = [];
                    
                    // Filter submissions for this worker
                    Object.keys(allSubmissions).forEach(key => {
                        const submission = allSubmissions[key];
                        if (submission.workerName === workerName) {
                            workerSubmissions.push({
                                ...submission,
                                firebaseKey: key
                            });
                        }
                    });
                    
                    console.log(`üìä Found ${workerSubmissions.length} submitted sessions in Firebase`);
                    
                    // Replace local submissions with Firebase data
                    data.submissions = workerSubmissions;
                }
                
                // Save to localStorage
                saveData(data);
                
                console.log('‚úÖ Worker data loaded and synced to localStorage');
                console.log(`   - History: ${data.history.length} sessions`);
                console.log(`   - Submissions: ${data.submissions.length} submissions`);
                
            } catch (error) {
                console.error('‚ùå Error loading worker data:', error);
                // Don't throw error - continue with empty data
            }
        }

        // Authentication state change listener
        onAuthStateChanged(auth, async (user) => {
            console.log('üîê Auth state changed:', user ? 'Signed in' : 'Signed out');
            
            if (user) {
                currentUser = user;
                console.log('üë§ User authenticated');
                
                // üî• NEW: Check Firebase first using stable device fingerprint
                const isRegistered = await checkExistingDevice();
                
                if (isRegistered) {
                    // Device found in Firebase - auto-loaded!
                    console.log('‚úÖ Device auto-loaded from Firebase');
                    isDeviceRegistered = true;
                    hideRegistrationScreen();
                    initApp();
                } else {
                    // Device not registered - show registration screen
                    console.log('‚ö†Ô∏è Device not registered, showing registration screen');
                    setTimeout(() => showRegistrationScreen(), 100);
                }
            } else {
                // Not signed in - sign in anonymously
                console.log('üîÑ Signing in anonymously...');
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error('‚ùå Anonymous sign-in error:', error);
                    await customAlert('Authentication error. Please refresh the page.', '‚ùå');
                }
            }
        });

        // ========================================
        // üì¶ FIREBASE DRAFTS MANAGEMENT
        // ========================================
        
        let isSyncing = false;
        let syncIndicator = null;
        
        // üî• Track pending Firebase saves to prevent premature deletion
        const pendingSaves = new Set(); // Stores timestamps of sessions being saved
        const GRACE_PERIOD_MS = 30000; // 30 seconds grace period
        
        // Get worker name for drafts path
        function getWorkerName() {
            const data = loadData();
            return data.workerName || 'Unknown';
        }
        
        // Save session draft to Firebase
        window.saveDraftToFirebase = async function(session) {
            try {
                isSyncing = true;
                showSyncIndicator('syncing');
                
                // üî• Mark this session as pending save
                pendingSaves.add(session.timestamp);
                console.log('üîÑ Marking session as pending save:', session.timestamp);
                console.log('üìã Current pending saves:', Array.from(pendingSaves));
                
                const workerName = getWorkerName();
                const draftRef = ref(database, `drafts_v2/${workerName}/${session.timestamp}`);
                
                await window.firebaseSet(draftRef, {
                    ...session,
                    workerName: workerName,
                    lastModified: Date.now(),
                    deviceId: localStorage.getItem('deviceId') || 'unknown'
                });
                
                console.log('‚òÅÔ∏è Draft saved to Firebase:', session.timestamp);
                
                // üî• Remove from pending saves after successful save
                pendingSaves.delete(session.timestamp);
                console.log('‚úÖ Session confirmed saved, removed from pending:', session.timestamp);
                console.log('üìã Remaining pending saves:', Array.from(pendingSaves));
                
                showSyncIndicator('synced');
                isSyncing = false;
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to save draft to Firebase:', error);
                
                // üî• Keep in pending saves on error (will retry or delete later)
                console.warn('‚ö†Ô∏è Session still in pending saves due to error:', session.timestamp);
                
                showSyncIndicator('error');
                isSyncing = false;
                return false;
            }
        };
        
        // Delete draft from Firebase
        window.deleteDraftFromFirebase = async function(timestamp) {
            try {
                const workerName = getWorkerName();
                const draftRef = ref(database, `drafts_v2/${workerName}/${timestamp}`);
                await window.firebaseRemove(draftRef);
                console.log('üóëÔ∏è Draft deleted from Firebase:', timestamp);
            } catch (error) {
                console.error('‚ùå Failed to delete draft from Firebase:', error);
            }
        };
        
        // Load drafts from Firebase (recovery)
        async function loadDraftsFromFirebase() {
            try {
                console.log('üì• Loading drafts from Firebase...');
                const workerName = getWorkerName();
                const draftsRef = ref(database, `drafts_v2/${workerName}`);
                
                return new Promise((resolve) => {
                    window.firebaseOnValue(draftsRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const firebaseDrafts = snapshot.val();
                            const draftsArray = Object.values(firebaseDrafts);
                            console.log(`‚òÅÔ∏è Found ${draftsArray.length} drafts in Firebase`);
                            resolve(draftsArray);
                        } else {
                            console.log('üì≠ No drafts found in Firebase');
                            resolve([]);
                        }
                    }, { onlyOnce: true });
                });
            } catch (error) {
                console.error('‚ùå Failed to load drafts from Firebase:', error);
                return [];
            }
        }
        
        // Sync indicator UI
        function showSyncIndicator(status) {
            if (!syncIndicator) {
                syncIndicator = document.createElement('div');
                syncIndicator.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 8px; font-size: 12px; transition: all 0.3s;';
                document.body.appendChild(syncIndicator);
            }
            
            const icons = {
                syncing: 'üîÑ',
                synced: '‚òÅÔ∏è‚úÖ',
                error: '‚ö†Ô∏è',
                offline: 'üì¥'
            };
            
            const messages = {
                syncing: 'Syncing...',
                synced: 'Synced',
                error: 'Sync Error',
                offline: 'Offline'
            };
            
            const colors = {
                syncing: '#3b82f6',
                synced: '#10b981',
                error: '#ef4444',
                offline: '#f59e0b'
            };
            
            syncIndicator.innerHTML = `<span style="font-size: 16px;">${icons[status]}</span><span style="color: ${colors[status]}; font-weight: 600;">${messages[status]}</span>`;
            syncIndicator.style.display = 'flex';
            
            if (status === 'synced') {
                setTimeout(() => {
                    syncIndicator.style.display = 'none';
                }, 3000);
            }
        }
        
        // Recover data from Firebase on app start
        async function recoverDataFromFirebase() {
            try {
                console.log('üîÑ Checking for data recovery...');
                const data = loadData();
                const firebaseDrafts = await loadDraftsFromFirebase();
                
                if (firebaseDrafts.length > 0) {
                    console.log(`üì¶ Recovering ${firebaseDrafts.length} drafts from Firebase...`);
                    
                    // Merge Firebase drafts with local data
                    const localTimestamps = data.history.map(h => h.timestamp);
                    let recovered = 0;
                    
                    firebaseDrafts.forEach(draft => {
                        // Only add if not already in local history
                        if (!localTimestamps.includes(draft.timestamp)) {
                            data.history.push(draft);
                            recovered++;
                        }
                    });
                    
                    if (recovered > 0) {
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        console.log(`‚úÖ Recovered ${recovered} sessions from Firebase!`);
                        await customAlert(`‚úÖ Recovered ${recovered} unsaved session(s) from cloud backup!`, '‚ÑπÔ∏è');
                    } else {
                        console.log('‚úÖ All drafts already synced');
                    }
                } else {
                    console.log('‚úÖ No recovery needed');
                }
            } catch (error) {
                console.error('‚ùå Recovery error:', error);
            }
        }
        
        // ========================================
        // üßπ CLEANUP CORRUPTED SESSIONS
        // ========================================
        async function cleanupCorruptedSessions() {
            try {
                console.log('üßπ Checking for corrupted sessions...');
                const data = loadData();
                let cleaned = 0;
                
                // Find corrupted sessions (NaN, undefined, Invalid Date)
                const corruptedSessions = data.history.filter(h => {
                    // Duration entries don't have startTime, so check entryType first
                    const isDuration = h.entryType === 'duration';
                    
                    const isCorrupted = 
                        !h.endTime || 
                        (!isDuration && !h.startTime) ||  // Only check startTime for non-duration entries
                        isNaN(new Date(h.endTime).getTime()) ||
                        isNaN(h.duration) ||
                        h.payment === undefined ||
                        h.clientName === undefined;
                    
                    if (isCorrupted) {
                        console.log('üóëÔ∏è Found corrupted session:', h);
                    }
                    
                    return isCorrupted;
                });
                
                if (corruptedSessions.length > 0) {
                    console.log(`üóëÔ∏è Cleaning ${corruptedSessions.length} corrupted sessions...`);
                    
                    // Remove from local storage
                    data.history = data.history.filter(h => !corruptedSessions.includes(h));
                    saveData(data);
                    
                    // Also check and clean from Firebase submissions
                    const workerName = getWorkerName();
                    const submissionsRef = ref(database, 'submissions_v2');
                    const snapshot = await window.firebaseGet(submissionsRef);
                    
                    if (snapshot.exists()) {
                        const submissions = snapshot.val();
                        for (const [key, submission] of Object.entries(submissions)) {
                            if (submission.workerName === workerName) {
                                // Check if submission has corrupted sessions
                                if (submission.sessions && Array.isArray(submission.sessions)) {
                                    const hasCorrupted = submission.sessions.some(s => 
                                        !s.endTime || !s.startTime || isNaN(new Date(s.endTime).getTime())
                                    );
                                    
                                    if (hasCorrupted) {
                                        console.log('üóëÔ∏è Deleting corrupted submission from Firebase:', key);
                                        await window.firebaseRemove(ref(database, `submissions_v2/${key}`));
                                        cleaned++;
                                    }
                                }
                            }
                        }
                    }
                    
                    renderHistory();
                    updateSubmitSummary();
                    updateTodaySummary();
                    updateTotalSummary();
                    
                    console.log(`‚úÖ Cleaned ${corruptedSessions.length} local sessions and ${cleaned} Firebase submissions`);
                }
            } catch (error) {
                console.error('‚ùå Cleanup error:', error);
            }
        }
        
        // ========================================
        // üöÄ MAIN APP INITIALIZATION
        // ========================================
        
        function initApp() {
            console.log('üöÄ Initializing app...');
            
            // Check if we need to recover data from Firebase
            recoverDataFromFirebase();
            
            // Clean up any corrupted sessions
            cleanupCorruptedSessions();
            
            // ========================================
            // üî• REAL-TIME LISTENER: DRAFTS (UNSENT SESSIONS)
            // ========================================
            const workerName = getWorkerName();
            const draftsRef = ref(database, `drafts_v2/${workerName}`);
            
            console.log('üëÇ Setting up real-time listener for drafts...');
            
            onValue(draftsRef, (snapshot) => {
                try {
                    console.log('üî• Firebase drafts changed!');
                    
                    if (snapshot.exists()) {
                    const firebaseDrafts = snapshot.val();
                    const draftsArray = Object.values(firebaseDrafts);
                    console.log(`‚òÅÔ∏è Firebase has ${draftsArray.length} drafts`);
                    
                    const data = loadData();
                    const localTimestamps = data.history.map(h => h.timestamp);
                    let added = 0;
                    let removed = 0;
                    
                    // Add new drafts from Firebase that don't exist locally
                    draftsArray.forEach(draft => {
                        if (!localTimestamps.includes(draft.timestamp)) {
                            console.log('‚ûï Adding new draft from Firebase:', draft.timestamp);
                            data.history.push(draft);
                            added++;
                        }
                    });
                    
                    // Remove local drafts that don't exist in Firebase (were submitted on another device)
                    const firebaseTimestamps = draftsArray.map(d => d.timestamp);
                    const now = Date.now();
                    
                    data.history = data.history.filter(h => {
                        if (h.sent === false && !firebaseTimestamps.includes(h.timestamp)) {
                            // üî• SAFETY CHECK 1: Is this session pending save?
                            if (pendingSaves.has(h.timestamp)) {
                                console.log('‚ö†Ô∏è SKIPPING deletion - session is pending save:', h.timestamp);
                                return true; // Keep it!
                            }
                            
                            // üî• SAFETY CHECK 2: Was this session created < 30 seconds ago?
                            const ageMs = now - h.timestamp;
                            if (ageMs < GRACE_PERIOD_MS) {
                                console.log(`‚ö†Ô∏è SKIPPING deletion - session too recent (${Math.floor(ageMs/1000)}s old):`, h.timestamp);
                                return true; // Keep it!
                            }
                            
                            // Safe to delete - it's old and not pending
                            console.log(`‚ûñ Removing draft (submitted on another device, ${Math.floor(ageMs/1000)}s old):`, h.timestamp);
                            removed++;
                            return false;
                        }
                        return true;
                    });
                    
                    if (added > 0 || removed > 0) {
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                    updateTotalSummary();
                        console.log(`‚úÖ Synced: +${added} added, -${removed} removed`);
                    }
                } else {
                    // No drafts in Firebase - but be VERY careful before deleting!
                    console.log('üì≠ No drafts in Firebase');
                    const data = loadData();
                    const now = Date.now();
                    let removed = 0;
                    
                    // üî• CRITICAL: Only delete sessions that pass ALL safety checks
                    data.history = data.history.filter(h => {
                        if (h.sent === false) {
                            // SAFETY CHECK 1: Is this session pending save?
                            if (pendingSaves.has(h.timestamp)) {
                                console.log('‚ö†Ô∏è KEEPING session - pending save:', h.timestamp);
                                return true; // Keep it!
                            }
                            
                            // SAFETY CHECK 2: Was this session created < 30 seconds ago?
                            const ageMs = now - h.timestamp;
                            if (ageMs < GRACE_PERIOD_MS) {
                                console.log(`‚ö†Ô∏è KEEPING session - too recent (${Math.floor(ageMs/1000)}s old):`, h.timestamp);
                                return true; // Keep it!
                            }
                            
                            // SAFETY CHECK 3: Has enough time passed for Firebase to sync?
                            // If Firebase is empty but we have recent sessions, it might be a sync delay
                            if (ageMs < GRACE_PERIOD_MS * 2) { // Give extra time (60s)
                                console.log(`‚ö†Ô∏è KEEPING session - Firebase might be syncing (${Math.floor(ageMs/1000)}s old):`, h.timestamp);
                                return true; // Keep it!
                            }
                            
                            // Safe to delete - it's very old and confirmed not in Firebase
                            console.log(`‚ûñ Removing old draft (${Math.floor(ageMs/1000)}s old):`, h.timestamp);
                            removed++;
                            return false;
                        }
                        return true; // Keep sent sessions
                    });
                    
                    if (removed > 0) {
                        saveData(data);
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                    updateTotalSummary();
                        console.log(`‚úÖ Removed ${removed} old unsent sessions`);
                    }
                }
                } catch (error) {
                    console.error('‚ùå Error in drafts listener:', error);
                    console.error('Stack:', error.stack);
                    // Don't crash the app - just log the error
                }
            });
            
            // ========================================
            // üî• REAL-TIME LISTENER: SUBMISSIONS
            // ========================================
            const submissionsRef = ref(database, 'submissions_v2');
            
            console.log('üëÇ Setting up real-time listener for submissions...');
            
            onValue(submissionsRef, (snapshot) => {
                console.log('üî• Firebase submissions changed!');
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    const data = loadData();
                    
                    // Sync submissions from Firebase
                    const firebaseSubmissions = Object.values(firebaseData).filter(sub => 
                        sub.workerName === workerName
                    );
                    
                    console.log(`‚òÅÔ∏è Firebase has ${firebaseSubmissions.length} submissions for ${workerName}`);
                    
                    // Update local submissions
                    if (!data.submissions) data.submissions = [];
                    
                    // üî• CRITICAL: If Firebase has 0 submissions for this worker but we have local ones, they were ALL deleted!
                    if (firebaseSubmissions.length === 0 && data.submissions.length > 0) {
                        console.log('‚ö†Ô∏è CRITICAL: Firebase has 0 submissions but local has', data.submissions.length, '- they were deleted!');
                        const allDeletedSessions = [];
                        data.submissions.forEach(sub => {
                            console.log('üóëÔ∏è Marking submission for deletion:', sub.timestamp);
                            if (sub.sessions && Array.isArray(sub.sessions)) {
                                sub.sessions.forEach(session => {
                                    if (session.endTime) {
                                        allDeletedSessions.push(session.endTime);
                                    }
                                });
                            }
                        });
                        
                        // Clear all submissions
                        data.submissions = [];
                        
                        // Remove all sessions from history
                        if (allDeletedSessions.length > 0) {
                            const historyBefore = data.history.length;
                            data.history = data.history.filter(h => 
                                !allDeletedSessions.includes(h.endTime)
                            );
                            const historyAfter = data.history.length;
                            console.log(`üóëÔ∏è Removed ${historyBefore - historyAfter} sessions from history (all submissions deleted)`);
                        }
                        
                        saveData(data);
                        renderSubmissionHistory();
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                    updateTotalSummary();
                        console.log('‚úÖ All submissions cleared from worker app');
                        return; // Exit early, no need to continue processing
                    }
                    
                    const localTimestamps = data.submissions.map(s => s.timestamp);
                    let addedSubs = 0;
                    let updatedSubs = 0;
                    
                    firebaseSubmissions.forEach(firebaseSub => {
                        const localIndex = data.submissions.findIndex(s => s.timestamp === firebaseSub.timestamp);
                        
                        if (localIndex === -1) {
                            // New submission from another device
                            console.log('‚ûï Adding new submission from Firebase:', firebaseSub.timestamp);
                            data.submissions.push(firebaseSub);
                            addedSubs++;
                        } else {
                            // Update existing submission (status, payments, etc.)
                            const localSub = data.submissions[localIndex];
                            if (JSON.stringify(localSub) !== JSON.stringify(firebaseSub)) {
                                console.log('üîÑ Updating submission from Firebase:', firebaseSub.timestamp);
                                data.submissions[localIndex] = firebaseSub;
                                updatedSubs++;
                            }
                        }
                        
                        // ========================================
                        // üî• ALSO UPDATE data.history[] FOR HISTORY TAB
                        // ========================================
                        // Submission contains sessions[] array - sync each session to history
                        if (firebaseSub.sessions && Array.isArray(firebaseSub.sessions)) {
                            firebaseSub.sessions.forEach(session => {
                                const historyIndex = data.history.findIndex(h => 
                                    h.endTime === session.endTime && h.duration === session.duration
                                );
                                
                                if (historyIndex === -1) {
                                    // New session not in history - add it
                                    console.log('üìù Adding session to history:', session.endTime);
                                    data.history.push({
                                        ...session,
                                        sent: true
                                    });
                                } else {
                                    // Update existing history entry - mark as sent
                                    console.log('üîÑ Updating session in history:', session.endTime);
                                    data.history[historyIndex] = {
                                        ...session,
                                        sent: true
                                    };
                                }
                            });
                        }
                    });
                    
                    // ========================================
                    // üóëÔ∏è DETECT DELETIONS (Admin deleted from Firebase)
                    // ========================================
                    console.log('üîç Checking for deletions...');
                    console.log('Firebase timestamps:', firebaseSubmissions.map(s => s.timestamp));
                    console.log('Local timestamps:', data.submissions.map(s => s.timestamp));
                    
                    const firebaseTimestamps = firebaseSubmissions.map(s => s.timestamp);
                    const deletedSubs = data.submissions.filter(localSub => 
                        !firebaseTimestamps.includes(localSub.timestamp)
                    );
                    
                    console.log('üóëÔ∏è Deleted submissions count:', deletedSubs.length);
                    
                    if (deletedSubs.length > 0) {
                        console.log(`üóëÔ∏è Detected ${deletedSubs.length} deleted submissions from Firebase`);
                        
                        // Collect all session timestamps from deleted submissions
                        const deletedSessionTimestamps = [];
                        deletedSubs.forEach(deleted => {
                            console.log('üóëÔ∏è Removing deleted submission:', deleted.timestamp);
                            if (deleted.sessions && Array.isArray(deleted.sessions)) {
                                deleted.sessions.forEach(session => {
                                    if (session.endTime) {
                                        deletedSessionTimestamps.push(session.endTime);
                                    }
                                });
                            }
                        });
                        
                        // Remove deleted submissions from local data
                        data.submissions = data.submissions.filter(localSub => 
                            firebaseTimestamps.includes(localSub.timestamp)
                        );
                        
                        // ========================================
                        // üî• ALSO REMOVE FROM data.history[]
                        // ========================================
                        if (deletedSessionTimestamps.length > 0) {
                            const historyBefore = data.history.length;
                            data.history = data.history.filter(h => 
                                !deletedSessionTimestamps.includes(h.endTime)
                            );
                            const historyAfter = data.history.length;
                            console.log(`üóëÔ∏è Removed ${historyBefore - historyAfter} sessions from history`);
                        }
                    }
                    
                    if (addedSubs > 0 || updatedSubs > 0 || deletedSubs.length > 0) {
                        saveData(data);
                        renderSubmissionHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                    updateTotalSummary();
                        console.log(`‚úÖ Submissions synced: +${addedSubs} added, ${updatedSubs} updated, -${deletedSubs.length} deleted`);
                    }
                    
                    // üî• ALWAYS update History tab (includes unsent sessions from manual entry)
                    renderHistory();
                } else {
                    // ========================================
                    // üî• NO SUBMISSIONS IN FIREBASE AT ALL
                    // ========================================
                    console.log('üì≠ No submissions in Firebase (for ANY worker)');
                    const data = loadData();
                    
                    if (data.submissions && data.submissions.length > 0) {
                        console.log('‚ö†Ô∏è CRITICAL: Worker has', data.submissions.length, 'submissions locally but Firebase has NONE');
                        console.log('   This means ALL submissions were deleted by admin!');
                        
                        // Collect all session timestamps before clearing
                        const allSessionTimestamps = [];
                        data.submissions.forEach(sub => {
                            console.log('üóëÔ∏è Removing submission from localStorage:', sub.timestamp);
                            if (sub.sessions && Array.isArray(sub.sessions)) {
                                sub.sessions.forEach(session => {
                                    if (session.endTime) {
                                        allSessionTimestamps.push(session.endTime);
                                    }
                                });
                            }
                        });
                        
                        // Clear all submissions
                        data.submissions = [];
                        
                        // Remove all submitted sessions from history
                        if (allSessionTimestamps.length > 0) {
                            const historyBefore = data.history.length;
                            data.history = data.history.filter(h => 
                                !allSessionTimestamps.includes(h.endTime)
                            );
                            const historyAfter = data.history.length;
                            console.log(`üóëÔ∏è Removed ${historyBefore - historyAfter} sessions from history (all deleted by admin)`);
                        }
                        
                        saveData(data);
                        renderSubmissionHistory();
                        renderHistory();
                        updateSubmitSummary();
                        updateTodaySummary();
                    updateTotalSummary();
                        console.log('‚úÖ All submissions cleared from worker (deleted by admin)');
                    }
                }
            });
            
            // ========================================
            // üí∞ LOAD EXPENSES SUBMISSIONS (REAL-TIME)
            // ========================================
            console.log('üí∞ Initializing expenses submissions listener...');
            loadExpenseSubmissionsFromFirebase();
            
            // Initialize expenses view if it exists
            if (document.getElementById('expenses-view')) {
                renderExpenses();
            }
        } // End of initApp()

        // Note: initApp() will be called automatically after authentication succeeds
    </script>

    <script>
        // Show notification when status changes to approved
        function showApprovalNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('‚úÖ Work Approved!', {
                    body: 'Your submitted work has been approved by admin.',
                    icon: 'https://via.placeholder.com/192/667eea/ffffff.png?text=ET'
                });
            }
        }
    </script>

    <script>
        // ========================================
        // üåê LANGUAGE SYSTEM (MUST BE FIRST!)
        // ========================================
        
        let currentLang = localStorage.getItem('language') || 'en';
        
        // ========================================
        // üïê TIME FORMAT (MUST BE EARLY!)
        // ========================================
        let timeFormat = localStorage.getItem('timeFormat') || '24h';
        let submissionTab = localStorage.getItem('submissionTab') || 'active'; // Track which tab is active
        
        const translations = {
            en: {
                app_title: "üöú Excavator Timer",
                app_subtitle: "Track your work time & earnings",
                tab_timer: "Live Timer",
                tab_manual: "Manual Entry",
                tab_history: "History",
                tab_settings: "Settings",
                start: "Start",
                stop: "Stop",
                resume: "Resume",
                calculate: "Calculate",
                save_history: "Save to History",
                submit_admin: "Submit to Admin",
                add_payment: "Add Payment",
                clear_all: "Clear All History",
                delete: "Delete",
                cancel: "Cancel",
                confirm: "Confirm",
                job_site: "üìç Job Site",
                client_name: "üë§ Client Name",
                hourly_rate: "üí∞ Hourly Rate (MAD)",
                worker_name: "Worker Name",
                start_time: "Start Time",
                stop_time: "Stop Time",
                pending: "Pending",
                approved: "Approved",
                unpaid: "Unpaid",
                partially_paid: "Partially Paid",
                fully_paid: "Fully Paid",
                select_job: "Select or Create Job",
                or_text: "OR",
                saved_jobs: "Saved Jobs",
                no_saved_jobs: "No saved jobs yet",
                start_working: "Start Working",
                stop_save: "Stop & Save",
                pause: "Pause",
                timer_running: "Timer Running",
                timer_paused: "Timer Paused",
                current_job: "Current Job",
                duration: "Duration",
                payment: "Payment",
                today_summary: "üìä Today's Summary",
                total_all_summary: "üìà Total ALL Sessions",
                total_time: "Total Time",
                total_payment: "Total Payment",
                manual_entry_title: "üìù Manual Time Entry",
                manual_entry_desc: "Enter start and stop times to calculate work duration and payment",
                duration_payment: "Duration & Payment",
                work_history: "Work History",
                no_history: "No history yet",
                at: "at",
                worker_settings: "Worker Settings",
                your_name: "Your Name",
                name_appears: "This name will appear in admin reports",
                save_name: "Save Name",
                submit_sessions: "Submit Work Sessions",
                send_unsent: "Send unsent work sessions to admin",
                unsent_sessions: "Unsent Sessions:",
                total_hours: "Total Hours:",
                no_sessions: "No sessions to send",
                submission_history: "Submission History",
                active_submissions: "Active",
                completed_submissions: "Completed",
                no_submissions: "No submissions yet",
                no_active_submissions: "No active submissions",
                no_completed_submissions: "No completed submissions",
                waiting_approval: "Waiting for admin approval",
                approved_by: "Approved by admin",
                paid: "Paid:",
                remaining: "Remaining:",
                payment_history: "Payment History",
                payments: "payments",
                sessions: "sessions",
                session: "session",
                client: "Client:",
                total_amount: "Total Amount:",
                already_paid: "Already Paid:",
                payment_amount: "Payment Amount (MAD):",
                device_registration: "Device Registration",
                registration_desc: "Enter your registration code to access the app. Contact your admin if you don't have a code.",
                register_device: "Register This Device",
                edit: "Edit",
                edit_session: "Edit Session",
                save_changes: "Save Changes",
                original_price: "Original Price:",
                adjusted_price: "Adjusted Price:",
                time_format: "Time Format",
                time_format_24h: "24-hour (14:30)",
                time_format_12h: "12-hour (2:30 PM)",
                adjust_price: "Adjust Price",
                discount_reason: "Discount/Adjustment Reason:",
                apply_discount: "Apply Adjustment",
                reset_price: "Reset to Original",
                morning: "Morning (AM)",
                evening: "Evening (PM)",
                time_range_entry: "Time Range",
                duration_entry: "Duration Entry",
                work_date: "Work Date",
                work_hours: "Work Hours",
                work_minutes: "Work Minutes",
                duration_label: "Duration",
                mark_fully_paid: "Mark as fully paid",
                client_cannot_pay_more: "(Client cannot pay the remaining amount)",
                confirm_full_payment: "Client can only pay {amount} MAD?",
                remaining_unpayable: "Remaining {amount} MAD will be marked as unpayable.",
                worker_marked_paid: "Worker marked as fully paid",
                cannot_pay_remaining: "Client cannot pay remaining {amount} MAD",
                clear_unsent_sessions: "Clear Unsent Sessions",
                clear_submission_history: "Clear Submission History",
                confirm_clear_unsent: "Delete all unsent work sessions? This cannot be undone!",
                confirm_clear_submissions: "‚ö†Ô∏è WARNING: Delete ALL submission history?\n\nThis will permanently delete:\n‚Ä¢ All submitted sessions\n‚Ä¢ All payment records\n‚Ä¢ All work history\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?",
                // Expenses translations
                tab_expenses: "üí∞ Expenses",
                exp_today: "Today",
                exp_week: "This Week",
                exp_month: "This Month",
                exp_add_new: "üí∞ Add New Expense",
                exp_repair: "Repair",
                exp_fuel: "Fuel",
                exp_parts: "Parts",
                exp_unsent: "üìù Unsent Expenses",
                exp_no_unsent: "No unsent expenses",
                exp_submit_all: "üì§ Submit All Expenses",
                exp_submitted_history: "üìã Submitted Expenses History",
                exp_filter_today: "Today",
                exp_filter_week: "This Week",
                exp_filter_month: "This Month",
                exp_filter_all: "All",
                exp_no_submitted: "No submitted expenses yet",
                exp_add_repair: "Add Repair Expense",
                exp_add_fuel: "Add Fuel Expense",
                exp_add_parts: "Add Parts Expense",
                exp_date: "üìÖ Date",
                exp_amount: "üí∞ Amount (MAD)",
                exp_description: "üìù Description",
                exp_save: "Save Expense",
                exp_price_per_liter: "üí∞ Price per Liter (MAD)",
                exp_liters: "‚õΩ Liters",
                exp_total_amount: "Total Amount",
                exp_part_name: "üî© Part Name",
                exp_price: "üí∞ Price (MAD)",
                exp_notes: "üìù Notes (Optional)",
                exp_edit: "Edit Expense",
                exp_pending: "Pending",
                exp_approved: "Approved",
                exp_rejected: "Rejected"
            },
            ar: {
                app_title: "ŸÖÿ§ŸÇÿ™ ÿπŸÖŸÑ ÿßŸÑÿ≠ŸÅÿßÿ±ÿ© üöú",
                app_subtitle: "ÿ™ÿ™ÿ®ÿπ ŸàŸÇÿ™ ÿπŸÖŸÑŸÉ Ÿàÿ£ÿ±ÿ®ÿßÿ≠ŸÉ",
                tab_timer: "ÿßŸÑŸÖÿ§ŸÇŸëÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±",
                tab_manual: "ÿ•ÿØÿÆÿßŸÑ ŸäÿØŸàŸä",
                tab_history: "ÿßŸÑÿ≥ÿ¨ŸÑ",
                tab_settings: "ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™",
                start: "ÿ®ÿØÿ°",
                stop: "ÿ•ŸäŸÇÿßŸÅ",
                resume: "ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ",
                calculate: "ÿ≠ÿ≥ÿßÿ®",
                save_history: "ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑ",
                submit_admin: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                add_payment: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ®ŸÑÿ∫",
                clear_all: "ŸÖÿ≥ÿ≠ ŸÉŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ",
                delete: "ÿ≠ÿ∞ŸÅ",
                cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
                confirm: "ÿ™ÿ£ŸÉŸäÿØ",
                job_site: "üìç ŸÖŸàŸÇÿπ ÿßŸÑÿπŸÖŸÑ",
                client_name: "üë§ ÿ•ÿ≥ŸÖ ÿßŸÑÿ≤ÿ®ŸàŸÜ",
                hourly_rate: "üí∞ ÿßŸÑÿ£ÿ¨ÿ± ÿ®ÿßŸÑÿ≥ÿßÿπÿ© (ÿØÿ±ŸáŸÖ)",
                worker_name: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                start_time: "ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿ°",
                stop_time: "ŸàŸÇÿ™ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°",
                pending: "ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©",
                approved: "ŸÖŸèÿπÿ™ŸÖÿØ",
                unpaid: "ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ",
                partially_paid: "ŸÖÿØŸÅŸàÿπ ÿ¨ÿ≤ÿ¶ŸäŸãÿß",
                fully_paid: "ŸÖÿØŸÅŸàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ",
                select_job: "ÿßÿÆÿ™ÿ± ÿ£Ÿà ÿ£ŸÜÿ¥ÿ¶ ÿπŸÖŸÑ",
                or_text: "ÿ£Ÿà",
                saved_jobs: "ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©",
                no_saved_jobs: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿπŸÖÿßŸÑ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ÿπÿØ",
                start_working: "ÿ®ÿØÿ° ÿßŸÑÿπŸÖŸÑ",
                stop_save: "ÿ•ŸäŸÇÿßŸÅ Ÿàÿ≠ŸÅÿ∏",
                pause: "ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™",
                timer_running: "ÿßŸÑŸÖÿ§ŸÇÿ™ ŸäÿπŸÖŸÑ",
                timer_paused: "ÿßŸÑŸÖÿ§ŸÇÿ™ ŸÖÿ™ŸàŸÇŸÅ",
                current_job: "ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ≠ÿßŸÑŸä",
                duration: "ÿßŸÑŸÖÿØÿ©",
                payment: "ÿßŸÑŸÖÿ®ŸÑÿ∫",
                today_summary: "üìä ŸÖŸÑÿÆÿµ ÿßŸÑŸäŸàŸÖ",
                total_time: "ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
                total_payment: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
                manual_entry_title: "ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸàŸÇÿ™ ŸäÿØŸàŸäÿßŸã",
                manual_entry_desc: "ÿ£ÿØÿÆŸÑ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿ®ÿØÿ° ŸàÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿØÿ© ÿßŸÑÿπŸÖŸÑ ŸàÿßŸÑŸÖÿ®ŸÑÿ∫",
                duration_payment: "ÿßŸÑŸÖÿØÿ© ŸàÿßŸÑŸÖÿ®ŸÑÿ∫",
                work_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑ",
                no_history: "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿπŸÖŸÑ ÿ®ÿπÿØ",
                at: "ŸÅŸä",
                worker_settings: "ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ",
                your_name: "ÿßÿ≥ŸÖŸÉ",
                name_appears: "ÿ≥Ÿäÿ∏Ÿáÿ± Ÿáÿ∞ÿß ÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±",
                save_name: "ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ≥ŸÖ",
                submit_sessions: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿπŸÖŸÑ",
                send_unsent: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©",
                unsent_sessions: "ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©:",
                total_hours: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿßÿπÿßÿ™:",
                no_sessions: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨ŸÑÿ≥ÿßÿ™ ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ",
                submission_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ",
                active_submissions: "ŸÜÿ¥ÿ∑",
                completed_submissions: "ŸÖŸÉÿ™ŸÖŸÑ",
                no_submissions: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ±ÿ≥ÿßŸÑÿßÿ™ ÿ®ÿπÿØ",
                no_active_submissions: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ±ÿ≥ÿßŸÑÿßÿ™ ŸÜÿ¥ÿ∑ÿ©",
                no_completed_submissions: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ±ÿ≥ÿßŸÑÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ©",
                waiting_approval: "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖÿ¥ÿ±ŸÅ",
                approved_by: "ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ±ŸÅ",
                paid: "ÿßŸÑŸÖÿØŸÅŸàÿπ:",
                remaining: "ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:",
                payment_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™",
                payments: "ÿØŸÅÿπÿßÿ™",
                sessions: "ÿ¨ŸÑÿ≥ÿßÿ™",
                session: "ÿ¨ŸÑÿ≥ÿ©",
                client: "ÿßŸÑÿ≤ÿ®ŸàŸÜ:",
                total_amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:",
                already_paid: "ÿßŸÑŸÖÿØŸÅŸàÿπ:",
                payment_amount: "ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿØŸÅÿπÿ© (ÿØÿ±ŸáŸÖ):",
                device_registration: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨Ÿáÿßÿ≤",
                registration_desc: "ÿ£ÿØÿÆŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ÿßÿ™ÿµŸÑ ÿ®ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑÿØŸäŸÉ ÿ±ŸÖÿ≤.",
                register_device: "ÿ™ÿ≥ÿ¨ŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ¨Ÿáÿßÿ≤",
                edit: "ÿ™ÿπÿØŸäŸÑ",
                edit_session: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿ©",
                save_changes: "ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™",
                original_price: "ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ£ÿµŸÑŸä:",
                adjusted_price: "ÿßŸÑÿ≥ÿπÿ± ÿßŸÑŸÖÿπÿØŸÑ:",
                time_format: "ÿµŸäÿ∫ÿ© ÿßŸÑŸàŸÇÿ™",
                time_format_24h: "24 ÿ≥ÿßÿπÿ© (14:30)",
                time_format_12h: "12 ÿ≥ÿßÿπÿ© (2:30 ŸÖ)",
                adjust_price: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿπÿ±",
                discount_reason: "ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿµŸÖ/ÿßŸÑÿ™ÿπÿØŸäŸÑ:",
                apply_discount: "ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿπÿØŸäŸÑ",
                reset_price: "ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ£ÿµŸÑŸä",
                morning: "ÿµÿ®ÿßÿ≠Ÿãÿß",
                evening: "ŸÖÿ≥ÿßÿ°Ÿã",
                time_range_entry: "ŸÜÿ∑ÿßŸÇ ÿßŸÑŸàŸÇÿ™",
                duration_entry: "ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿØÿ©",
                work_date: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿπŸÖŸÑ",
                work_hours: "ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ",
                work_minutes: "ÿØŸÇÿßÿ¶ŸÇ ÿßŸÑÿπŸÖŸÑ",
                duration_label: "ÿßŸÑŸÖÿØÿ©",
                mark_fully_paid: "ÿ™ÿ≠ÿØŸäÿØ ŸÉŸÖÿØŸÅŸàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ",
                client_cannot_pay_more: "(ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÑÿß Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿØŸÅÿπ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä)",
                confirm_full_payment: "ÿßŸÑÿ≤ÿ®ŸàŸÜ Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿØŸÅÿπ {amount} ÿØÿ±ŸáŸÖ ŸÅŸÇÿ∑ÿü",
                remaining_unpayable: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä {amount} ÿØÿ±ŸáŸÖ ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØŸá ŸÉÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑÿØŸÅÿπ.",
                worker_marked_paid: "ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ŸÉŸÖÿØŸÅŸàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿπÿßŸÖŸÑ",
                cannot_pay_remaining: "ÿßŸÑÿ≤ÿ®ŸàŸÜ ŸÑÿß Ÿäÿ≥ÿ™ÿ∑Ÿäÿπ ÿØŸÅÿπ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä {amount} ÿØÿ±ŸáŸÖ",
                clear_unsent_sessions: "ŸÖÿ≥ÿ≠ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©",
                clear_submission_history: "ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑŸäÿßÿ™",
                confirm_clear_unsent: "ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°!",
                confirm_clear_submissions: "‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑŸäÿßÿ™ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶ŸäŸãÿß:\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿØŸÅÿπ\n‚Ä¢ ÿ¨ŸÖŸäÿπ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿπŸÖŸÑ\n\nŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°!\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ™ŸÖÿßŸÖŸãÿßÿü",
                // Expenses translations (Arabic)
                tab_expenses: "ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ üí∞",
                exp_today: "ÿßŸÑŸäŸàŸÖ",
                exp_week: "Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
                exp_month: "Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±",
                exp_add_new: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ÿ¨ÿØŸäÿØ üí∞",
                exp_repair: "ÿ•ÿµŸÑÿßÿ≠",
                exp_fuel: "ŸàŸÇŸàÿØ",
                exp_parts: "ŸÇÿ∑ÿπ ÿ∫Ÿäÿßÿ±",
                exp_unsent: "ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ© üìù",
                exp_no_unsent: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿµÿßÿ±ŸäŸÅ ÿ∫Ÿäÿ± ŸÖÿ±ÿ≥ŸÑÿ©",
                exp_submit_all: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ üì§",
                exp_submitted_history: "ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ© üìã",
                exp_filter_today: "ÿßŸÑŸäŸàŸÖ",
                exp_filter_week: "Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ",
                exp_filter_month: "Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±",
                exp_filter_all: "ÿßŸÑŸÉŸÑ",
                exp_no_submitted: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿµÿßÿ±ŸäŸÅ ŸÖÿ±ÿ≥ŸÑÿ© ÿ®ÿπÿØ",
                exp_add_repair: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ÿ•ÿµŸÑÿßÿ≠",
                exp_add_fuel: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ŸàŸÇŸàÿØ",
                exp_add_parts: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ ŸÇÿ∑ÿπ ÿ∫Ÿäÿßÿ±",
                exp_date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ üìÖ",
                exp_amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿØÿ±ŸáŸÖ) üí∞",
                exp_description: "ÿßŸÑŸàÿµŸÅ üìù",
                exp_save: "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿµÿ±ŸàŸÅ",
                exp_price_per_liter: "ÿßŸÑÿ≥ÿπÿ± ŸÑŸÉŸÑ ŸÑÿ™ÿ± (ÿØÿ±ŸáŸÖ) üí∞",
                exp_liters: "ÿπÿØÿØ ÿßŸÑŸÑÿ™ÿ±ÿßÿ™ ‚õΩ",
                exp_total_amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
                exp_part_name: "ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ∑ÿπÿ© üî©",
                exp_price: "ÿßŸÑÿ≥ÿπÿ± (ÿØÿ±ŸáŸÖ) üí∞",
                exp_notes: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä) üìù",
                exp_edit: "ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿµÿ±ŸàŸÅ",
                exp_pending: "ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©",
                exp_approved: "ŸÖŸèÿπÿ™ŸÖÿØ",
                exp_rejected: "ŸÖÿ±ŸÅŸàÿ∂"
            }
        };

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('language', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const html = document.documentElement;
            const body = document.body;
            const langToggle = document.getElementById('lang-toggle');
            
            if (currentLang === 'ar') {
                html.setAttribute('dir', 'rtl');
                html.setAttribute('lang', 'ar');
                body.setAttribute('dir', 'rtl');
                if (langToggle) langToggle.textContent = 'EN';
            } else {
                html.setAttribute('dir', 'ltr');
                html.setAttribute('lang', 'en');
                body.setAttribute('dir', 'ltr');
                if (langToggle) langToggle.textContent = 'AR';
            }
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    // For option elements, update text content
                    if (el.tagName === 'OPTION') {
                        el.textContent = translations[currentLang][key];
                    } else {
                        el.textContent = translations[currentLang][key];
                    }
                }
            });
            
            if (typeof renderSavedJobs === 'function') renderSavedJobs();
            if (typeof renderManualSavedJobs === 'function') renderManualSavedJobs();
            if (typeof renderHistory === 'function') renderHistory();
            if (typeof renderSubmissionHistory === 'function') renderSubmissionHistory();
            if (typeof updateTodaySummary === 'function') updateTodaySummary();
            if (typeof updateTotalSummary === 'function') updateTotalSummary();
            
            console.log('üåê Language changed to:', currentLang);
        }

        window.addEventListener('DOMContentLoaded', () => {
            applyLanguage();
            
            // Set today's date as default in manual entry
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            const dateInput = document.getElementById('manual-work-date');
            if (dateInput) {
                dateInput.value = todayStr;
            }
            
            // Initialize submission tab buttons state
            const savedTab = localStorage.getItem('submissionTab') || 'active';
            if (savedTab === 'completed') {
                // Set completed tab as active on load if it was selected before
                setTimeout(() => {
                    const btnCompleted = document.getElementById('submission-tab-completed');
                    if (btnCompleted) {
                        btnCompleted.style.background = '#2563eb';
                        btnCompleted.style.color = 'white';
                        btnCompleted.style.borderColor = '#2563eb';
                    }
                    const btnActive = document.getElementById('submission-tab-active');
                    if (btnActive) {
                        btnActive.style.background = 'white';
                        btnActive.style.color = '#64748b';
                        btnActive.style.borderColor = '#e2e8f0';
                    }
                }, 100);
            }
        });

        // ========================================
        // üìä MAIN APP CODE
        // ========================================

        let timerInterval = null;
        let startTime = null;
        let elapsedTime = 0;
        let isPaused = false;
        let currentJob = null;
        let reminderInterval = null;

        // Date formatting helper - DD/MM/YYYY format
        function formatDate(dateInput) {
            const date = new Date(dateInput);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function loadData() {
            const data = localStorage.getItem('excavatorTimer');
            const parsed = data ? JSON.parse(data) : { jobs: [], history: [] };
            
            // Fix: Mark all old sessions without 'sent' property as unsent
            if (parsed.history && parsed.history.length > 0) {
                parsed.history.forEach(h => {
                    if (h.sent === undefined) {
                        h.sent = false;
                    }
                });
                // Save the fixed data back
                saveData(parsed);
            }
            
            return parsed;
        }

        function saveData(data) {
            localStorage.setItem('excavatorTimer', JSON.stringify(data));
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function formatHM(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return h + 'h ' + m + 'm';
        }

        function calculatePayment(seconds, rate) {
            const payment = (seconds / 3600) * rate;
            return Math.floor(payment).toFixed(2); // Round DOWN to remove decimals
        }

        function updateTimer() {
            if (!isPaused) {
                elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            }
            document.getElementById('timer').textContent = formatTime(elapsedTime);
            document.getElementById('payment').textContent = calculatePayment(elapsedTime, currentJob.rate) + ' MAD';
        }

        function startTimer() {
            const data = loadData();
            const selected = document.querySelector('.saved-job-item.selected');
            
            let jobSite, clientName, rate;
            if (selected) {
                const job = data.jobs[parseInt(selected.dataset.index)];
                jobSite = job.jobSite;
                clientName = job.clientName;
                rate = job.rate;
            } else {
                jobSite = document.getElementById('job-site').value.trim();
                clientName = document.getElementById('client-name').value.trim();
                rate = parseFloat(document.getElementById('hourly-rate').value);
            }

            if (!jobSite || !clientName || !rate || rate <= 0) {
                return;
            }

            if (!selected && !data.jobs.find(j => j.jobSite === jobSite && j.clientName === clientName)) {
                data.jobs.push({ jobSite: jobSite, clientName: clientName, rate: rate });
                saveData(data);
            }

            currentJob = { jobSite: jobSite, clientName: clientName, rate: rate, startTime: new Date().toISOString() };
            document.getElementById('current-job-site').textContent = jobSite;
            document.getElementById('current-client-name').textContent = clientName;
            document.getElementById('current-rate').textContent = rate;
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('timer-section').style.display = 'block';

            startTime = Date.now();
            elapsedTime = 0;
            isPaused = false;
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();

            startReminder();
            if (Notification.permission === 'default') Notification.requestPermission();
        }

        function pauseTimer() {
            if (isPaused) {
                startTime = Date.now() - (elapsedTime * 1000);
                isPaused = false;
                document.getElementById('pause-btn').textContent = 'Pause';
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                isPaused = true;
                document.getElementById('pause-btn').textContent = 'Resume';
                clearInterval(timerInterval);
            }
        }

        async function stopTimer() {
            clearInterval(timerInterval);
            clearInterval(reminderInterval);

            const data = loadData();
            const endTime = new Date();
            const workDateStr = endTime.getFullYear() + '-' + 
                               String(endTime.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(endTime.getDate()).padStart(2, '0');
            
            const newSession = {
                timestamp: Date.now(),
                jobSite: currentJob.jobSite,
                clientName: currentJob.clientName,
                rate: currentJob.rate,
                startTime: currentJob.startTime,
                endTime: endTime.toISOString(),
                duration: elapsedTime,
                payment: calculatePayment(elapsedTime, currentJob.rate),
                workDate: workDateStr,
                sent: false
            };
            
            data.history.push(newSession);
            saveData(data);
            
            // Auto-save to Firebase
            await window.saveDraftToFirebase(newSession);

            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('timer-section').style.display = 'none';
            document.getElementById('job-site').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('hourly-rate').value = '';
            const sel = document.querySelector('.saved-job-item.selected');
            if (sel) sel.classList.remove('selected');

            currentJob = null;
            elapsedTime = 0;
            updateTodaySummary();
            updateTotalSummary();
            renderSavedJobs();
        }

        function startReminder() {
            reminderInterval = setInterval(() => {
                if (!isPaused && Notification.permission === 'granted') {
                    new Notification('‚è∞ Work Timer Reminder', {
                        body: 'You have been working for ' + formatHM(elapsedTime) + '. Remember to take breaks!'
                    });
                }
            }, 60 * 60 * 1000);
        }

        function updateTodaySummary() {
            const data = loadData();
            const today = new Date().toDateString();
            const todaySessions = data.history.filter(h => new Date(h.endTime).toDateString() === today);
            const totalSeconds = todaySessions.reduce((sum, h) => sum + h.duration, 0);
            const totalPayment = todaySessions.reduce((sum, h) => sum + parseFloat(h.payment), 0);
            document.getElementById('today-hours').textContent = formatHM(totalSeconds);
            document.getElementById('today-payment').textContent = totalPayment.toFixed(2) + ' MAD';
        }

        function updateTotalSummary() {
            const data = loadData();
            // Show ALL sessions (from all time)
            const allSessions = data.history;
            const totalSeconds = allSessions.reduce((sum, h) => sum + h.duration, 0);
            const totalPayment = allSessions.reduce((sum, h) => sum + parseFloat(h.payment), 0);
            document.getElementById('total-hours').textContent = formatHM(totalSeconds);
            document.getElementById('total-payment').textContent = totalPayment.toFixed(2) + ' MAD';
        }

        function renderSavedJobs() {
            // Removed: Saved jobs section no longer exists in Live Timer tab
            console.log('‚ÑπÔ∏è renderSavedJobs called (deprecated - saved jobs removed)');
            return;
        }

        function selectJob(index) {
            document.querySelectorAll('.saved-job-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.saved-job-item')[index].classList.add('selected');
            document.getElementById('job-site').value = '';
            document.getElementById('client-name').value = '';
            document.getElementById('hourly-rate').value = '';
        }

        function renderHistory() {
            const data = loadData();
            const container = document.getElementById('history-list');
            if (data.history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px;">No history yet</p>';
                return;
            }
            const sorted = [...data.history].sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
            container.innerHTML = sorted.map((h, originalIndex) => {
                // Find original index in unsorted array
                const actualIndex = data.history.findIndex(item => 
                    item.endTime === h.endTime && item.duration === h.duration
                );
                const date = new Date(h.endTime);
                const jobSite = h.jobSite || h.job || 'Unknown';
                const clientName = h.clientName || h.job || 'Unknown';
                
                // Check if session is unsent (can be edited)
                const isUnsent = h.sent === false || h.sent === undefined;
                const editBtn = isUnsent 
                    ? '<button class="delete-history-btn" onclick="editHistory(' + actualIndex + ')" style="right: 70px; background: #dbeafe; color: #2563eb;">‚úèÔ∏è ' + t('edit') + '</button>' 
                    : '';
                
                // Check if this is a duration entry
                let timeDisplay;
                if (h.entryType === 'duration') {
                    // Duration entry: show "‚è±Ô∏è Duration: 5h 30m"
                    timeDisplay = '‚è±Ô∏è ' + t('duration_label') + ': ' + formatHM(h.duration);
                } else {
                    // Regular time range entry: show "08:30 - 17:00"
                    timeDisplay = 'üïê ' + formatTimeDisplay(h.startTime) + ' - ' + formatTimeDisplay(h.endTime);
                }
                
                return '<div class="history-item">' +
                    '<button class="delete-history-btn" onclick="deleteHistory(' + actualIndex + ')">' + t('delete') + '</button>' +
                    editBtn +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + 
                    formatDate(date) + '</div>' +
                    '<div style="font-size: 11px; color: #64748b; margin-bottom: 5px;">' + timeDisplay + '</div>' +
                    '<div style="font-size: 13px; color: #64748b; margin-bottom: 3px;">üìç ' + jobSite + '</div>' +
                    '<div style="font-weight: 600; margin-bottom: 8px;">üë§ ' + clientName + '</div>' +
                    '<div style="display: flex; justify-content: space-between; font-size: 14px; padding-right: 80px;">' +
                    '<span>' + formatHM(h.duration) + ' @ ' + h.rate + ' MAD/hr</span>' +
                    '<span style="color: #2563eb; font-weight: 600; font-size: 16px;">' + h.payment + ' MAD</span></div></div>';
            }).join('');
        }

        async function deleteHistory(index) {
            const data = loadData();
            const session = data.history[index];
            
            console.log('üóëÔ∏è Deleting session:', session);
            
            // Delete from Firebase (for both sent and unsent sessions)
            if (session.timestamp) {
                // If unsent session, delete from drafts
                if (session.sent === false || session.sent === undefined) {
                    console.log('üóëÔ∏è Deleting unsent session from Firebase drafts...');
                    await window.deleteDraftFromFirebase(session.timestamp);
                } else if (session.sent === true && session.firebaseKey) {
                    // If sent session, delete from submissions
                    console.log('üóëÔ∏è Deleting sent session from Firebase submissions...');
                    const submissionRef = ref(database, `submissions_v2/${session.firebaseKey}`);
                    await window.firebaseRemove(submissionRef);
                    console.log('‚úÖ Deleted from Firebase submissions');
                }
            }
            
            // Delete from local storage
            data.history.splice(index, 1);
            saveData(data);
            
            renderHistory();
            updateTodaySummary();
            updateTotalSummary();
            
            console.log('‚úÖ Session deleted successfully');
        }

        // Clear only unsent sessions
        async function clearUnsentSessions() {
            const data = loadData();
            const unsentCount = data.history.filter(h => h.sent === false || h.sent === undefined).length;
            
            if (unsentCount === 0) {
                await customAlert('No unsent sessions to clear!', '‚ÑπÔ∏è');
                return;
            }
            
            const confirmed = await customConfirm(t('confirm_clear_unsent'), '‚ö†Ô∏è');
            if (!confirmed) return;
            
            // Delete unsent sessions from Firebase
            const unsentSessions = data.history.filter(h => h.sent === false || h.sent === undefined);
            for (const session of unsentSessions) {
                if (session.timestamp) {
                    await window.deleteDraftFromFirebase(session.timestamp);
                }
            }
            
            // Remove unsent sessions from local data
            data.history = data.history.filter(h => h.sent === true);
            saveData(data);
            
            renderHistory();
            updateTodaySummary();
            updateTotalSummary();
            updateSubmitSummary();
            
            await customAlert(`‚úÖ Cleared ${unsentCount} unsent session(s)!`, '‚úÖ');
        }

        // Clear all submission history (LOCAL VIEW ONLY - Firebase keeps records)
        async function clearSubmissionHistory() {
            const data = loadData();
            const submissionCount = data.submissions ? data.submissions.length : 0;
            
            if (submissionCount === 0) {
                await customAlert('No submission history to clear!', '‚ÑπÔ∏è');
                return;
            }
            
            const confirmed = await customConfirm(t('confirm_clear_submissions'), '‚ö†Ô∏è');
            if (!confirmed) return;
            
            // Clear submissions from local view only (Firebase keeps permanent records)
            console.log('üóëÔ∏è Clearing local submission history...');
            console.log(`   Note: Firebase records are kept for admin (permanent backup)`);
            
            data.submissions = [];
            saveData(data);
            
            renderSubmissionHistory();
            
            await customAlert(`‚úÖ Cleared ${submissionCount} submission(s) from local view!\n\nNote: Admin still has records in cloud backup.`, '‚úÖ');
        }

        // ========================================
        // üé® CUSTOM MODAL SYSTEM (No URL shown!)
        // ========================================
        
        // Custom Alert - replaces native alert()
        function customAlert(message, icon = '‚ÑπÔ∏è') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customAlertModal');
                const messageDiv = document.getElementById('customAlertMessage');
                const iconDiv = document.getElementById('customAlertIcon');
                const okBtn = document.getElementById('customAlertOkBtn');
                
                messageDiv.textContent = message;
                iconDiv.textContent = icon;
                modal.style.display = 'flex';
                
                const handleOk = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    resolve(true);
                };
                
                okBtn.addEventListener('click', handleOk);
            });
        }
        
        // Custom Confirm - replaces native confirm()
        function customConfirm(message, icon = '‚ö†Ô∏è') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageDiv = document.getElementById('customConfirmMessage');
                const iconDiv = document.getElementById('customConfirmIcon');
                const okBtn = document.getElementById('customConfirmOkBtn');
                const cancelBtn = document.getElementById('customConfirmCancelBtn');
                
                messageDiv.textContent = message;
                iconDiv.textContent = icon;
                modal.style.display = 'flex';
                
                const handleOk = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.style.display = 'none';
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        // Custom Prompt - replaces native prompt()
        function customPrompt(message, icon = '‚úèÔ∏è') {
            return new Promise((resolve) => {
                // Create prompt modal dynamically
                const modal = document.createElement('div');
                modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; margin: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; font-size: 48px; margin-bottom: 15px;">${icon}</div>
                        <div style="font-size: 16px; color: #1e293b; text-align: center; margin-bottom: 20px; line-height: 1.6;">${message}</div>
                        <input type="text" id="customPromptInput" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;" placeholder="Enter your name" autofocus>
                        <div style="display: flex; gap: 10px;">
                            <button id="customPromptCancelBtn" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">Cancel</button>
                            <button id="customPromptOkBtn" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white;">OK</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const inputField = document.getElementById('customPromptInput');
                const okBtn = document.getElementById('customPromptOkBtn');
                const cancelBtn = document.getElementById('customPromptCancelBtn');
                
                // Focus on input
                setTimeout(() => inputField.focus(), 100);
                
                const handleOk = () => {
                    const value = inputField.value.trim();
                    document.body.removeChild(modal);
                    resolve(value);
                };
                
                const handleCancel = () => {
                    document.body.removeChild(modal);
                    resolve(null);
                };
                
                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        handleOk();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                inputField.addEventListener('keydown', handleEnter);
            });
        }

        async function clearAllHistory() {
            const firstConfirm = await customConfirm('‚ö†Ô∏è Are you sure you want to delete ALL history?\n\nThis will:\n- Delete all work sessions\n- Delete all submissions\n- Clear all saved jobs\n\nThis action CANNOT be undone!', '‚ö†Ô∏è');
            if (!firstConfirm) {
                return;
            }

            // Second confirmation for safety
            const secondConfirm = await customConfirm('Final confirmation: Delete EVERYTHING?', 'üö®');
            if (!secondConfirm) {
                return;
            }

            // Clear all data
            const data = {
                jobs: [],
                history: [],
                submissions: [],
                workerName: loadData().workerName // Keep worker name
            };
            saveData(data);

            // Update UI
            renderHistory();
            updateTodaySummary();
            updateTotalSummary();
            updateTotalSummary();
            renderSavedJobs();
            
            await customAlert('‚úÖ All history cleared!', '‚úÖ');
            
            // Refresh the page to reset everything
            location.reload();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-view').classList.add('active');
            if (tab === 'history') renderHistory();
            if (tab === 'manual') renderManualSavedJobs();
            if (tab === 'settings') loadSettings();
        }

        function loadSettings() {
            const data = loadData();
            const workerName = data.workerName || '';
            document.getElementById('worker-name').value = workerName;
            updateSubmitSummary();
            renderSubmissionHistory();
            initializeTimeFormat();
        }

        function saveWorkerName() {
            const name = document.getElementById('worker-name').value.trim();
            if (!name) return;
            
            const data = loadData();
            data.workerName = name;
            saveData(data);
        }

        function updateSubmitSummary() {
            const data = loadData();
            
            // Mark all sessions as not sent initially if property doesn't exist
            data.history.forEach(h => {
                if (h.sent === undefined) h.sent = false;
            });
            
            // Get ALL unsent sessions (not just today's)
            const unsentSessions = data.history.filter(h => h.sent === false);
            
            const submitBtn = document.querySelector('[onclick="submitToAdmin()"]');
            
            if (unsentSessions.length === 0) {
                document.getElementById('submit-summary').innerHTML = 
                    '<p style="color: #94a3b8; text-align: center;">' + t('no_sessions') + '</p>';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                    submitBtn.textContent = t('no_sessions').toUpperCase();
                }
                return;
            }

            // Calculate total payment (considering adjusted prices)
            const totalSeconds = unsentSessions.reduce((sum, h) => sum + h.duration, 0);
            const totalPayment = unsentSessions.reduce((sum, h) => {
                const price = h.adjustedPrice !== undefined ? parseFloat(h.adjustedPrice) : parseFloat(h.payment);
                return sum + price;
            }, 0);

            // Build session list with adjust price buttons
            let sessionListHTML = '';
            unsentSessions.forEach((session, index) => {
                const actualIndex = data.history.findIndex(h => 
                    h.endTime === session.endTime && h.duration === session.duration
                );
                const clientName = session.clientName || session.job || 'Unknown';
                const jobSite = session.jobSite || session.job || 'Unknown';
                const originalPrice = parseFloat(session.payment);
                const currentPrice = session.adjustedPrice !== undefined ? parseFloat(session.adjustedPrice) : originalPrice;
                const isPriceAdjusted = session.adjustedPrice !== undefined && session.adjustedPrice !== session.payment;
                
                sessionListHTML += 
                    '<div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ' + (isPriceAdjusted ? '#f59e0b' : '#2563eb') + ';">' +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 3px;">üìç ' + jobSite + '</div>' +
                    '<div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">üë§ ' + clientName + '</div>' +
                    '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                    '<div style="font-size: 13px; color: #64748b;">' + formatHM(session.duration) + '</div>' +
                    '<div style="text-align: right;">' +
                    (isPriceAdjusted ? 
                        '<div style="font-size: 11px; color: #94a3b8; text-decoration: line-through;">' + originalPrice.toFixed(2) + ' MAD</div>' +
                        '<div style="font-size: 16px; font-weight: 600; color: #f59e0b;">‚ö° ' + currentPrice.toFixed(2) + ' MAD</div>' 
                        : 
                        '<div style="font-size: 16px; font-weight: 600; color: #2563eb;">' + currentPrice.toFixed(2) + ' MAD</div>'
                    ) +
                    '</div></div>' +
                    '<button onclick="showPriceAdjustModal(' + actualIndex + ')" style="width: 100%; margin-top: 8px; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer;">üí∞ ' + t('adjust_price') + '</button>' +
                    '</div>';
            });

            document.getElementById('submit-summary').innerHTML = sessionListHTML +
                '<div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #0ea5e9;">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">' +
                '<span style="color: #0c4a6e; font-weight: 600;">' + t('total_hours') + '</span>' +
                '<strong style="color: #0c4a6e;">' + formatHM(totalSeconds) + '</strong></div>' +
                '<div style="display: flex; justify-content: space-between;">' +
                '<span style="color: #0c4a6e; font-weight: 600;">' + t('total_payment') + '</span>' +
                '<strong style="color: #0369a1; font-size: 18px;">' + totalPayment.toFixed(2) + ' MAD</strong></div></div>';
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.textContent = t('submit_admin').toUpperCase();
            }
        }

        async function submitToAdmin() {
            console.log('=== SUBMIT BUTTON CLICKED ===');
            const data = loadData();
            console.log('Loaded data:', data);
            const workerName = data.workerName || 'Unknown Worker';
            
            if (!data.workerName) {
                console.log('ERROR: No worker name set!');
                await customAlert('Please save your name first!', '‚ö†Ô∏è');
                return;
            }

            // Get ALL unsent sessions (regardless of date)
            const unsentSessions = data.history.filter(h => h.sent === false);

            console.log('Unsent sessions found:', unsentSessions);

            if (unsentSessions.length === 0) {
                console.log('ERROR: No unsent sessions to submit');
                await customAlert('No unsent sessions to submit!', '‚ÑπÔ∏è');
                return;
            }

            // ‚ú® NEW: Group sessions by CLIENT NAME
            const groupedByClient = {};
            unsentSessions.forEach(session => {
                const clientName = session.clientName || session.job || 'Unknown';
                if (!groupedByClient[clientName]) {
                    groupedByClient[clientName] = [];
                }
                groupedByClient[clientName].push(session);
            });

            console.log('üìä Grouped by client:', groupedByClient);
            console.log('üìä Number of clients:', Object.keys(groupedByClient).length);

            // Create SEPARATE submission for EACH client
            const submissionsCreated = [];
            
            for (const [clientName, clientSessions] of Object.entries(groupedByClient)) {
                const totalSeconds = clientSessions.reduce((sum, h) => sum + h.duration, 0);
                // Use adjusted price if available, otherwise use original payment
                const totalPayment = clientSessions.reduce((sum, h) => {
                    const price = h.adjustedPrice !== undefined ? parseFloat(h.adjustedPrice) : parseFloat(h.payment);
                    return sum + price;
                }, 0);

            console.log('üîç DEBUG: First session workDate:', clientSessions[0].workDate);
            console.log('üîç DEBUG: First session full object:', clientSessions[0]);
            
            const submission = {
                workerName: workerName,
                    clientName: clientName,
                    date: clientSessions[0].workDate ? new Date(clientSessions[0].workDate).toISOString() : new Date().toISOString(),
                    sessions: clientSessions,
                totalHours: formatHM(totalSeconds),
                    totalPayment: Math.floor(totalPayment).toFixed(2),
                    timestamp: Date.now() + submissionsCreated.length, // Unique timestamp
                    status: 'pending',
                    paymentStatus: 'unpaid',
                    totalPaid: 0,
                    payments: []
                };

                console.log('üîç DEBUG: Submission date field:', submission.date);
                submissionsCreated.push(submission);
                console.log('‚úÖ Created submission for client:', clientName, submission);
            }

            // Mark ALL sessions as sent
            data.history.forEach(h => {
                const isInUnsent = unsentSessions.find(us => 
                    us.endTime === h.endTime && us.duration === h.duration
                );
                if (isInUnsent) {
                    h.sent = true;
                }
            });

            // Send EACH submission to Firebase FIRST, then save locally with Firebase keys
            if (!data.submissions) data.submissions = [];
            
            try {
                for (const submission of submissionsCreated) {
                    const submissionsRef = window.firebaseRef(window.firebaseDB, 'submissions_v2');
                    const newSubmissionRef = window.firebasePush(submissionsRef);
                    const firebaseKey = newSubmissionRef.key;
                    
                    await window.firebaseSet(newSubmissionRef, submission);
                    
                    // Add Firebase key to submission BEFORE saving locally
                    submission.firebaseKey = firebaseKey;
                    
                    console.log('‚úÖ Sent to Firebase with key:', firebaseKey, 'Client:', submission.clientName);
                    console.log('   Timestamp:', submission.timestamp);
                }
                
                // NOW save all submissions locally (with Firebase keys included)
                submissionsCreated.forEach(sub => data.submissions.push(sub));
                saveData(data);
                
                console.log('üéâ All', submissionsCreated.length, 'submissions sent successfully!');
                console.log('üìù Saved submissions with Firebase keys:', data.submissions.map(s => ({ 
                    timestamp: s.timestamp, 
                    firebaseKey: s.firebaseKey, 
                    client: s.clientName 
                })));
                
                // Delete drafts from Firebase after successful submission
                console.log('üóëÔ∏è Deleting submitted drafts from Firebase...');
                for (const session of unsentSessions) {
                    if (session.timestamp) {
                        await window.deleteDraftFromFirebase(session.timestamp);
                    }
                }
                console.log('‚úÖ Drafts cleaned up from Firebase');
                
            } catch (error) {
                console.error('‚ùå Firebase error:', error);
                await customAlert('Note: Saved locally but could not sync to admin. Check internet connection.', '‚ö†Ô∏è');
            }

            // Force refresh
            setTimeout(() => {
            renderSubmissionHistory();
            updateSubmitSummary();
            }, 100);
        }

        // Switch between Active and Completed submission tabs
        function switchSubmissionTab(tab) {
            submissionTab = tab;
            localStorage.setItem('submissionTab', tab);
            
            // Update button styles
            const btnActive = document.getElementById('submission-tab-active');
            const btnCompleted = document.getElementById('submission-tab-completed');
            
            if (tab === 'active') {
                btnActive.style.background = '#2563eb';
                btnActive.style.color = 'white';
                btnActive.style.borderColor = '#2563eb';
                
                btnCompleted.style.background = 'white';
                btnCompleted.style.color = '#64748b';
                btnCompleted.style.borderColor = '#e2e8f0';
            } else {
                btnCompleted.style.background = '#2563eb';
                btnCompleted.style.color = 'white';
                btnCompleted.style.borderColor = '#2563eb';
                
                btnActive.style.background = 'white';
                btnActive.style.color = '#64748b';
                btnActive.style.borderColor = '#e2e8f0';
            }
            
            // Re-render submissions with filter
            renderSubmissionHistory();
        }

        function renderSubmissionHistory() {
            const data = loadData();
            const submissions = data.submissions || [];
            const container = document.getElementById('submission-list');

            console.log('Rendering submissions:', submissions); // Debug

            // Categorize submissions
            const activeSubmissions = submissions.filter(s => s.paymentStatus !== 'fully_paid');
            const completedSubmissions = submissions.filter(s => s.paymentStatus === 'fully_paid');
            
            // Update counts
            const activeCountEl = document.getElementById('active-count');
            const completedCountEl = document.getElementById('completed-count');
            if (activeCountEl) activeCountEl.textContent = activeSubmissions.length;
            if (completedCountEl) completedCountEl.textContent = completedSubmissions.length;
            
            // Filter based on current tab
            const filteredSubmissions = submissionTab === 'active' ? activeSubmissions : completedSubmissions;

            if (filteredSubmissions.length === 0) {
                const emptyMessage = submissionTab === 'active' ? t('no_active_submissions') : t('no_completed_submissions');
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">' + emptyMessage + '</p>';
                return;
            }

            const sorted = [...filteredSubmissions].sort((a, b) => b.timestamp - a.timestamp);
            container.innerHTML = sorted.slice(0, 10).map((s, index) => {
                const date = new Date(s.date);
                const status = s.status || 'pending';
                const statusColor = status === 'approved' ? '#22c55e' : '#f59e0b';
                const statusText = status === 'approved' ? '‚úÖ ' + t('approved').toUpperCase() : '‚è≥ ' + t('pending').toUpperCase();
                const statusMessage = status === 'approved' ? t('approved_by') : t('waiting_approval');
                
                // Payment status
                const paymentStatus = s.paymentStatus || 'unpaid';
                const totalPaid = parseFloat(s.totalPaid || 0);
                const totalAmount = parseFloat(s.totalPayment);
                const remaining = totalAmount - totalPaid;
                const percentage = totalAmount > 0 ? Math.round((totalPaid / totalAmount) * 100) : 0;
                
                let paymentColor, paymentIcon, paymentText;
                if (paymentStatus === 'fully_paid') {
                    // Check if this is a "marked as fully paid" case (partial payment closed)
                    if (s.fullyPaidNote) {
                        paymentColor = '#f59e0b';
                        paymentIcon = 'üü†';
                        paymentText = 'PAYMENT CLOSED';
                    } else {
                        paymentColor = '#22c55e';
                        paymentIcon = '‚úÖ';
                        paymentText = t('fully_paid').toUpperCase();
                    }
                } else if (paymentStatus === 'partially_paid') {
                    paymentColor = '#f59e0b';
                    paymentIcon = 'üü°';
                    paymentText = t('partially_paid').toUpperCase();
                } else {
                    paymentColor = '#ef4444';
                    paymentIcon = 'üî¥';
                    paymentText = t('unpaid').toUpperCase();
                }
                
                const paymentsHistory = (s.payments || []).map(p => {
                    const pDate = new Date(p.date);
                    return '<div style="font-size: 11px; color: #64748b; padding: 3px 0;">‚úÖ ' + 
                           p.amount.toFixed(2) + ' MAD - ' + 
                           formatDate(pDate) + ' ' + pDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
                           '</div>';
                }).join('');
                
                const addPaymentBtn = paymentStatus !== 'fully_paid' 
                    ? '<button onclick="showAddPaymentModal(' + s.timestamp + ')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px;">üí∞ ' + t('add_payment') + '</button>'
                    : '';
                
                const clientName = s.clientName || (s.sessions && s.sessions[0] ? (s.sessions[0].clientName || s.sessions[0].job) : 'Unknown');
                const jobSites = s.sessions ? [...new Set(s.sessions.map(sess => sess.jobSite || sess.job || 'Unknown'))].join(', ') : 'Unknown';
                
                // Format the total payment display based on payment status
                let totalPaymentDisplay;
                if (s.fullyPaidNote) {
                    // Payment closed - show crossed out original + actual amount
                    totalPaymentDisplay = '<div style="text-align: right;">' +
                        '<div style="text-decoration: line-through; color: #94a3b8; font-size: 12px;">' + s.totalPayment + ' MAD</div>' +
                        '<strong style="color: #f59e0b; font-size: 16px;">' + totalPaid.toFixed(2) + ' MAD</strong>' +
                        '</div>';
                } else {
                    // Normal display
                    totalPaymentDisplay = '<strong style="color: #2563eb;">' + s.totalPayment + ' MAD</strong>';
                }
                
                // Submission date (when it was created/submitted)
                const submissionDate = new Date(s.timestamp || s.date);
                const submissionDateStr = formatDate(submissionDate);
                const submissionTimeStr = submissionDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Work date (actual date of the work - from first session)
                const workDateStr = s.sessions && s.sessions[0] && s.sessions[0].workDate 
                    ? formatDate(new Date(s.sessions[0].workDate))
                    : submissionDateStr;
                
                const dateDisplay = workDateStr !== submissionDateStr 
                    ? 'üìÖ Work: ' + workDateStr + ' <span style="color: #94a3b8; font-size: 10px;">| Submitted: ' + submissionDateStr + ' ' + submissionTimeStr + '</span>'
                    : 'üìÖ ' + workDateStr + ' <span style="color: #94a3b8; font-size: 10px;">at ' + submissionTimeStr + '</span>';
                
                return '<div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ' + statusColor + ';">' +
                    '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + 
                    dateDisplay + '</div>' +
                    
                    '<div style="font-size: 13px; color: #64748b; margin-bottom: 3px;">üìç ' + jobSites + '</div>' +
                    '<div style="font-weight: 600; font-size: 16px; color: #2563eb; margin-bottom: 8px;">üë§ ' + clientName + '</div>' +
                    
                    '<div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">' +
                    '<span>' + s.sessions.length + ' ' + (s.sessions.length === 1 ? t('session') : t('sessions')) + ' ¬∑ ' + s.totalHours + '</span>' +
                    totalPaymentDisplay + '</div>' +
                    
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                    '<span style="font-size: 12px; font-weight: 600; color: ' + statusColor + ';">' + statusText + '</span>' +
                    '<span style="font-size: 11px; color: #64748b;">' + statusMessage + '</span></div>' +
                    
                    '<div style="background: white; padding: 10px; border-radius: 6px; margin-top: 8px;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">' +
                    '<span style="font-size: 12px; font-weight: 600; color: ' + paymentColor + ';">' + paymentIcon + ' ' + paymentText + '</span>' +
                    '<span style="font-size: 11px; color: #64748b;">' + percentage + '%</span></div>' +
                    
                    (paymentStatus !== 'fully_paid' ? 
                        '<div style="font-size: 12px; color: #64748b; margin-top: 5px;">' +
                        t('paid') + ' <strong>' + totalPaid.toFixed(2) + ' MAD</strong> / ' + totalAmount.toFixed(2) + ' MAD<br>' +
                        t('remaining') + ' <strong style="color: #ef4444;">' + remaining.toFixed(2) + ' MAD</strong></div>' 
                        : 
                        // Check if this is a "marked as fully paid" case (show actual paid amount)
                        (s.fullyPaidNote ? 
                            '<div style="font-size: 12px; color: #f59e0b; margin-top: 5px;">' +
                            '<span style="text-decoration: line-through; color: #94a3b8;">' + totalAmount.toFixed(2) + ' MAD</span><br>' +
                            '<strong style="font-size: 16px; color: #f59e0b;">' + totalPaid.toFixed(2) + ' MAD</strong> ' +
                            '<span style="font-size: 11px; color: #64748b;">(actual amount received)</span>' +
                            '</div>' +
                            '<div style="font-size: 11px; color: #f59e0b; margin-top: 5px; padding: 5px; background: #fef3c7; border-radius: 4px;">‚ÑπÔ∏è ' + s.fullyPaidNote + '</div>'
                            :
                            '<div style="font-size: 12px; color: #22c55e; margin-top: 5px;">‚úÖ ' + t('fully_paid') + ': ' + totalAmount.toFixed(2) + ' MAD</div>'
                        )
                    ) +
                    
                    (paymentsHistory ? 
                        '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">' +
                        '<div style="font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 3px;">' + t('payment_history') + ':</div>' +
                        paymentsHistory + '</div>' 
                        : '') +
                    
                    addPaymentBtn +
                    '</div></div>';
            }).join('');
        }

        let manualCalculation = null;
        let manualEntryMethod = 'time-range'; // 'time-range' or 'duration'

        function switchManualMethod(method) {
            manualEntryMethod = method;
            console.log('üîÑ Switched to manual method:', method);
            
            const timeRangeBtn = document.getElementById('manual-method-time-range');
            const durationBtn = document.getElementById('manual-method-duration');
            const timeRangeFields = document.getElementById('time-range-fields');
            const durationFields = document.getElementById('duration-fields');
            
            if (method === 'time-range') {
                // Show time range fields, hide duration fields
                timeRangeFields.style.display = 'block';
                durationFields.style.display = 'none';
                
                // Update button styles
                timeRangeBtn.style.background = '#2563eb';
                timeRangeBtn.style.color = 'white';
                timeRangeBtn.style.borderColor = '#2563eb';
                
                durationBtn.style.background = 'white';
                durationBtn.style.color = '#64748b';
                durationBtn.style.borderColor = '#e2e8f0';
            } else {
                // Show duration fields, hide time range fields
                timeRangeFields.style.display = 'none';
                durationFields.style.display = 'block';
                
                // Update button styles
                timeRangeBtn.style.background = 'white';
                timeRangeBtn.style.color = '#64748b';
                timeRangeBtn.style.borderColor = '#e2e8f0';
                
                durationBtn.style.background = '#2563eb';
                durationBtn.style.color = 'white';
                durationBtn.style.borderColor = '#2563eb';
            }
            
            // Clear result display
            const resultEl = document.getElementById('manual-result');
            if (resultEl) resultEl.style.display = 'none';
            manualCalculation = null;
        }

        function renderManualSavedJobs() {
            // Removed: Saved jobs section no longer exists in Manual Entry tab
            // This function is kept for backwards compatibility but does nothing
            console.log('‚ÑπÔ∏è renderManualSavedJobs called (deprecated - saved jobs removed)');
            return;
        }

        function deleteJobFromManual(index) {
            const data = loadData();
            data.jobs.splice(index, 1);
            saveData(data);
            
            renderManualSavedJobs();
            renderSavedJobs();
        }

        function selectManualJob(index) {
            const data = loadData();
            const job = data.jobs[index];
            document.getElementById('manual-job-site').value = job.jobSite || job.name || '';
            document.getElementById('manual-client-name').value = job.clientName || job.name || '';
            document.getElementById('manual-hourly-rate').value = job.rate;
            document.querySelectorAll('#manual-saved-jobs .saved-job-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('#manual-saved-jobs .saved-job-item')[index].classList.add('selected');
        }

        async function calculateManual() {
            try {
                const jobSite = document.getElementById('manual-job-site').value.trim();
                const clientName = document.getElementById('manual-client-name').value.trim();
                const rate = parseFloat(document.getElementById('manual-hourly-rate').value);
                const workDate = document.getElementById('manual-work-date').value;

                console.log('üìä Calculate Manual called (method:', manualEntryMethod + ')');
                console.log('Common fields:', { jobSite, clientName, rate, workDate });

                // Basic validation
                if (!jobSite || !clientName || !rate) {
                    await customAlert('Please fill in Job Site, Client Name, and Hourly Rate!', '‚ö†Ô∏è');
                    return;
                }

                // Check if manualEntryMethod is 'duration' - use new calculation
                if (manualEntryMethod === 'duration') {
                    await calculateDuration(jobSite, clientName, rate, workDate);
                    return;
                }

                // Otherwise, use existing time-range calculation
                let startTime = document.getElementById('manual-start-time').value.trim();
                let stopTime = document.getElementById('manual-stop-time').value.trim();

                console.log('Time range fields:', { startTime, stopTime });

                if (!startTime || !stopTime) {
                    await customAlert('Please fill in start and stop times!', '‚ö†Ô∏è');
                    return;
                }
                
                console.log('‚úÖ All fields filled, proceeding...');
                console.log('‚è∞ Checking timeFormat variable...');
                console.log('‚è∞ timeFormat =', timeFormat);
                console.log('‚è∞ typeof timeFormat =', typeof timeFormat);

            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                console.log('üîÑ Converting 12h to 24h...');
                const startPeriod = document.getElementById('manual-start-period').value;
                const stopPeriod = document.getElementById('manual-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }

            // Validate time format (HH:MM)
            console.log('üîç Validating times:', { startTime, stopTime });
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            const startValid = timeRegex.test(startTime);
            const stopValid = timeRegex.test(stopTime);
            console.log('üîç Validation results:', { startValid, stopValid });
            
            if (!startValid || !stopValid) {
                await customAlert(`Invalid time format!\nStart: ${startTime} (${startValid ? 'OK' : 'FAIL'})\nStop: ${stopTime} (${stopValid ? 'OK' : 'FAIL'})`, '‚ö†Ô∏è');
                return;
            }
            console.log('‚úÖ Time validation passed!');

            // Get date (use work date if provided, otherwise today)
            let dateString;
            if (workDate) {
                dateString = workDate;
            } else {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateString = year + '-' + month + '-' + day;
            }

            console.log('üìÖ Date string:', dateString);
            console.log('‚è∞ Times after conversion:', { startTime, stopTime });

            // Combine date with time
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);

            console.log('üìÖ Start date:', start);
            console.log('üìÖ Stop date:', stop);

            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }

            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);

            console.log('‚è±Ô∏è Duration (seconds):', durationSeconds);
            console.log('üí∞ Payment:', payment);

            manualCalculation = {
                jobSite: jobSite,
                clientName: clientName,
                rate: rate,
                startTime: start.toISOString(),
                endTime: stop.toISOString(),
                duration: durationSeconds,
                payment: payment,
                entryType: 'time-range', // üî• Mark as time-range entry
                workDate: dateString,
                sent: false,
                timestamp: Date.now()
            };
            
            console.log('üîç DEBUG: Manual calculation created with workDate:', dateString);
            console.log('üîç DEBUG: Full manualCalculation object:', manualCalculation);

            console.log('‚úÖ Setting result display...');
            const durationEl = document.getElementById('manual-duration');
            const paymentEl = document.getElementById('manual-payment');
            const resultEl = document.getElementById('manual-result');
            
            console.log('üîç Elements found:', { durationEl: !!durationEl, paymentEl: !!paymentEl, resultEl: !!resultEl });
            
            if (durationEl) durationEl.textContent = formatHM(durationSeconds);
            if (paymentEl) paymentEl.textContent = payment + ' MAD';
            if (resultEl) resultEl.style.display = 'block';
            console.log('‚úÖ Result should be visible now!');

            // Save job if it's new
            const data = loadData();
            if (!data.jobs.find(j => j.jobSite === jobSite && j.clientName === clientName)) {
                data.jobs.push({ jobSite: jobSite, clientName: clientName, rate: rate });
                saveData(data);
                renderManualSavedJobs();
            }
            } catch (error) {
                console.error('‚ùå ERROR IN CALCULATE MANUAL:', error);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                await customAlert(`Calculation error: ${error.message}`, '‚ùå');
            }
        }

        // Calculate payment using duration entry method (hours + minutes)
        async function calculateDuration(jobSite, clientName, rate, workDate) {
            try {
                const hours = parseInt(document.getElementById('manual-duration-hours').value) || 0;
                const minutes = parseInt(document.getElementById('manual-duration-minutes').value) || 0;

                console.log('‚è±Ô∏è Duration entry:', { hours, minutes });

                if (hours === 0 && minutes === 0) {
                    await customAlert('Please enter at least some hours or minutes!', '‚ö†Ô∏è');
                    return;
                }

                // Allow any positive hours (for total work duration), minutes must be 0-59
                if (hours < 0 || minutes < 0 || minutes > 59) {
                    await customAlert('Invalid hours or minutes!\nHours: must be positive, Minutes: 0-59', '‚ö†Ô∏è');
                    return;
                }

                // Calculate total duration in seconds
                const durationSeconds = (hours * 3600) + (minutes * 60);

                // Calculate payment
                const payment = calculatePayment(durationSeconds, rate);

                // Get date (use work date if provided, otherwise today)
                let dateString;
                if (workDate) {
                    dateString = workDate;
                } else {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dateString = year + '-' + month + '-' + day;
                }

                const workDateTime = new Date(dateString + 'T12:00:00'); // Use noon as placeholder

                console.log('‚úÖ Duration calculation:', { durationSeconds, payment, dateString });

                // Store calculation result
                manualCalculation = {
                    jobSite: jobSite,
                    clientName: clientName,
                    rate: rate,
                    duration: durationSeconds,
                    payment: payment,
                    entryType: 'duration', // üî• Mark as duration entry
                    hours: hours,
                    minutes: minutes,
                    startTime: null, // No start time for duration entry
                    endTime: workDateTime.toISOString(), // Use work date as reference
                    workDate: dateString,
                    sent: false,
                    timestamp: Date.now()
                };

                // Display result
                const durationEl = document.getElementById('manual-duration');
                const paymentEl = document.getElementById('manual-payment');
                const resultEl = document.getElementById('manual-result');

                if (durationEl) durationEl.textContent = formatHM(durationSeconds);
                if (paymentEl) paymentEl.textContent = payment + ' MAD';
                if (resultEl) resultEl.style.display = 'block';

                console.log('‚úÖ Duration entry result displayed!');

                // Save job if it's new
                const data = loadData();
                if (!data.jobs.find(j => j.jobSite === jobSite && j.clientName === clientName)) {
                    data.jobs.push({ jobSite: jobSite, clientName: clientName, rate: rate });
                    saveData(data);
                    renderManualSavedJobs();
                }
            } catch (error) {
                console.error('‚ùå ERROR IN CALCULATE DURATION:', error);
                await customAlert(`Calculation error: ${error.message}`, '‚ùå');
            }
        }

        // Convert 12-hour time + AM/PM to 24-hour format
        function convertTo24Hour(time, period) {
            const [hours, minutes] = time.split(':').map(Number);
            let hour24 = hours;
            
            if (period === 'PM' && hours < 12) {
                hour24 = hours + 12;
            } else if (period === 'AM' && hours === 12) {
                hour24 = 0;
            }
            
            return String(hour24).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
        }

        async function saveManual() {
            if (!manualCalculation) {
                return;
            }

            const data = loadData();
            manualCalculation.sent = false; // Mark as not sent yet
            if (!manualCalculation.timestamp) {
                manualCalculation.timestamp = Date.now(); // Add timestamp if missing
            }
            data.history.push(manualCalculation);
            saveData(data);

            // Auto-save to Firebase
            await window.saveDraftToFirebase(manualCalculation);

            // Show success message
            const originalHTML = document.getElementById('manual-result').innerHTML;
            document.getElementById('manual-result').style.display = 'none';
            document.getElementById('manual-result').innerHTML = 
                '<div style="text-align: center; padding: 20px; background: #d1fae5; border-radius: 10px; color: #065f46; font-weight: 600;">' +
                '‚úÖ Work session saved to history!</div>';
            document.getElementById('manual-result').style.display = 'block';
            setTimeout(function() {
                document.getElementById('manual-result').style.display = 'none';
                // Restore original HTML structure
                document.getElementById('manual-result').innerHTML = 
                    '<div style="text-align: center;">' +
                    '<div style="font-size: 14px; color: #166534; margin-bottom: 10px;">Duration & Payment</div>' +
                    '<div style="font-size: 32px; font-weight: bold; color: #15803d;" id="manual-duration">0h 0m</div>' +
                    '<div style="font-size: 36px; font-weight: bold; color: #15803d; margin-top: 10px;" id="manual-payment">0.00 MAD</div>' +
                    '</div>';
            }, 3000);

            // Reset form
            document.getElementById('manual-job-site').value = '';
            document.getElementById('manual-client-name').value = '';
            document.getElementById('manual-hourly-rate').value = '';
            document.getElementById('manual-start-time').value = '';
            document.getElementById('manual-stop-time').value = '';
            document.getElementById('manual-result').style.display = 'none';
            document.querySelectorAll('#manual-saved-jobs .saved-job-item').forEach(el => el.classList.remove('selected'));
            manualCalculation = null;

            updateTodaySummary();
            updateTotalSummary();
            renderManualSavedJobs();
        }

        // Auto-format time input (add colon automatically)
        function formatTimeInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            input.value = value;
        }

        document.getElementById('manual-start-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        document.getElementById('manual-stop-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        // Listen to AM/PM changes in manual entry for auto-calculation
        document.getElementById('manual-start-period').addEventListener('change', function() {
            // Trigger calculation if all fields are filled
            const jobSite = document.getElementById('manual-job-site').value.trim();
            const clientName = document.getElementById('manual-client-name').value.trim();
            const rate = document.getElementById('manual-hourly-rate').value.trim();
            const startTime = document.getElementById('manual-start-time').value.trim();
            const stopTime = document.getElementById('manual-stop-time').value.trim();
            
            if (jobSite && clientName && rate && startTime && stopTime) {
                calculateManual();
            }
        });

        document.getElementById('manual-stop-period').addEventListener('change', function() {
            // Trigger calculation if all fields are filled
            const jobSite = document.getElementById('manual-job-site').value.trim();
            const clientName = document.getElementById('manual-client-name').value.trim();
            const rate = document.getElementById('manual-hourly-rate').value.trim();
            const startTime = document.getElementById('manual-start-time').value.trim();
            const stopTime = document.getElementById('manual-stop-time').value.trim();
            
            if (jobSite && clientName && rate && startTime && stopTime) {
                calculateManual();
            }
        });

        updateTodaySummary();
        renderSavedJobs();
        
        // Payment modal functions
        let currentPaymentSubmissionTimestamp = null;

        async function showAddPaymentModal(timestamp) {
            currentPaymentSubmissionTimestamp = timestamp;
            const data = loadData();
            const submission = data.submissions.find(s => s.timestamp === timestamp);
            
            if (!submission) {
                await customAlert('Error: Submission not found!', '‚ùå');
                return;
            }
            
            const totalAmount = parseFloat(submission.totalPayment);
            const totalPaid = parseFloat(submission.totalPaid || 0);
            const remaining = totalAmount - totalPaid;
            
            console.log('üí∞ Opening payment modal for submission:', {
                timestamp: timestamp,
                totalAmount: totalAmount,
                totalPaid: totalPaid,
                remaining: remaining
            });
            
            document.getElementById('paymentModalInfo').innerHTML = 
                '<strong>' + t('total_amount') + '</strong> ' + totalAmount.toFixed(2) + ' MAD<br>' +
                '<strong>' + t('already_paid') + '</strong> ' + totalPaid.toFixed(2) + ' MAD<br>' +
                '<strong>' + t('remaining') + '</strong> <span style="color: #ef4444; font-weight: 600;">' + remaining.toFixed(2) + ' MAD</span>';
            
            const paymentInput = document.getElementById('paymentAmount');
            paymentInput.value = '';
            paymentInput.max = remaining.toFixed(2);
            paymentInput.placeholder = currentLang === 'ar' ? 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ' : 'Enter amount received';
            paymentInput.disabled = false; // Re-enable input
            
            // Show/hide "Mark as fully paid" checkbox based on remaining amount
            const markFullyPaidSection = document.getElementById('markFullyPaidSection');
            const markFullyPaidCheckbox = document.getElementById('markFullyPaidCheckbox');
            markFullyPaidCheckbox.checked = false; // Reset checkbox
            
            // Only show checkbox if there's remaining amount
            if (remaining > 0) {
                markFullyPaidSection.style.display = 'block';
            } else {
                markFullyPaidSection.style.display = 'none';
            }
            
            // Add event listener to checkbox to disable/enable input
            markFullyPaidCheckbox.onchange = function() {
                if (this.checked) {
                    paymentInput.value = '0';
                    paymentInput.disabled = true;
                    paymentInput.style.opacity = '0.5';
                    paymentInput.style.cursor = 'not-allowed';
                } else {
                    paymentInput.value = '';
                    paymentInput.disabled = false;
                    paymentInput.style.opacity = '1';
                    paymentInput.style.cursor = 'text';
                }
            };
            
            document.getElementById('paymentModal').style.display = 'flex';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentSubmissionTimestamp = null;
        }

        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const markFullyPaid = document.getElementById('markFullyPaidCheckbox').checked;
            
            // If marking as fully paid, allow any amount (including 0)
            // Otherwise, require a valid amount
            if (!markFullyPaid && (!amount || amount <= 0)) {
                await customAlert('Please enter a valid payment amount', '‚ö†Ô∏è');
                return;
            }
            
            // If no amount entered but marking as fully paid, set amount to 0
            const finalAmount = amount || 0;
            
            const data = loadData();
            const submissionIndex = data.submissions.findIndex(s => s.timestamp === currentPaymentSubmissionTimestamp);
            
            if (submissionIndex === -1) {
                await customAlert('Error: Submission not found!', '‚ùå');
                return;
            }
            
            const submission = data.submissions[submissionIndex];
            
            const totalAmount = parseFloat(submission.totalPayment);
            const totalPaid = parseFloat(submission.totalPaid || 0);
            const remaining = totalAmount - totalPaid;
            
            // Only check if amount exceeds remaining if NOT marking as fully paid
            if (!markFullyPaid && finalAmount > remaining) {
                await customAlert('Payment amount (' + finalAmount.toFixed(2) + ' MAD) exceeds remaining amount (' + remaining.toFixed(2) + ' MAD)', '‚ö†Ô∏è');
                return;
            }
            
            // If "Mark as fully paid" is checked, confirm with user
            if (markFullyPaid) {
                let confirmMsg;
                if (finalAmount > 0) {
                    // Worker is adding a partial payment AND marking as fully paid
                    confirmMsg = `Add ${finalAmount.toFixed(2)} MAD and mark as fully paid?\n\nClient cannot pay the remaining ${(remaining - finalAmount).toFixed(2)} MAD.\nThis will close the payment.`;
                } else {
                    // Worker is just marking as fully paid with no additional payment
                    confirmMsg = `Mark this payment as fully paid?\n\nClient cannot pay the remaining ${remaining.toFixed(2)} MAD.\nThis will close the payment.`;
                }
                
                const confirmed = await customConfirm(confirmMsg, '‚ö†Ô∏è');
                if (!confirmed) {
                    return; // User cancelled
                }
            }
            
            // Add payment to array (only if amount > 0)
            if (!submission.payments) submission.payments = [];
            if (finalAmount > 0) {
                submission.payments.push({
                    amount: finalAmount,
                    date: Date.now()
                });
            }
            
            // Update total paid
            submission.totalPaid = totalPaid + finalAmount;
            
            // Update payment status
            if (markFullyPaid) {
                // Worker manually marked as fully paid (partial payment closed)
                submission.paymentStatus = 'fully_paid';
                // DON'T change totalPaid - keep actual amount paid!
                
                // Add note explaining why payment was closed early
                const waived = totalAmount - submission.totalPaid;
                submission.fullyPaidNote = t('worker_marked_paid') + ' - ' + t('cannot_pay_remaining').replace('{amount}', waived.toFixed(2));
            } else if (submission.totalPaid >= totalAmount - 0.01) {
                // Payment is actually complete (100%)
                submission.paymentStatus = 'fully_paid';
                submission.totalPaid = totalAmount; // Set to exact total amount to avoid rounding errors
            } else if (submission.totalPaid > 0) {
                submission.paymentStatus = 'partially_paid';
            } else {
                submission.paymentStatus = 'unpaid';
            }
            
            // Save locally
            saveData(data);
            
            // Update Firebase
            try {
                const firebaseKey = await findFirebaseKeyByTimestamp(submission.timestamp);
                console.log('üì§ Attempting to sync payment to Firebase...');
                console.log('   Submission timestamp:', submission.timestamp);
                console.log('   Firebase key:', firebaseKey);
                
                if (firebaseKey) {
                    const submissionRef = window.firebaseRef(window.firebaseDB, 'submissions_v2/' + firebaseKey);
                    
                    // üî• CRITICAL: Check if submission still exists in Firebase before updating!
                    const snapshot = await window.firebaseGet(submissionRef);
                    if (!snapshot.exists()) {
                        console.warn('‚ö†Ô∏è Submission no longer exists in Firebase (admin may have deleted it)');
                        console.warn('   Removing from local storage...');
                        
                        // Remove from local storage
                        const data = loadData();
                        data.submissions = data.submissions.filter(s => s.timestamp !== submission.timestamp);
                        
                        // Also remove sessions from history
                        if (submission.sessions && Array.isArray(submission.sessions)) {
                            const sessionTimestamps = submission.sessions.map(s => s.endTime);
                            data.history = data.history.filter(h => !sessionTimestamps.includes(h.endTime));
                        }
                        
                        saveData(data);
                        renderSubmissionHistory();
                        renderHistory();
                        
                        await customAlert('‚ö†Ô∏è This submission was deleted by admin. It has been removed from your app.', '‚ö†Ô∏è');
                        return;
                    }
                    
                    const updateData = {
                        payments: submission.payments,
                        totalPaid: submission.totalPaid,
                        paymentStatus: submission.paymentStatus
                    };
                    
                    // Include fullyPaidNote if it exists
                    if (submission.fullyPaidNote) {
                        updateData.fullyPaidNote = submission.fullyPaidNote;
                    }
                    
                    console.log('   Update data:', updateData);
                    
                    await window.firebaseUpdate(submissionRef, updateData);
                    console.log('‚úÖ Payment synced to Firebase successfully!');
                } else {
                    console.error('‚ùå No Firebase key found! Cannot sync to Firebase.');
                    await customAlert('‚ö†Ô∏è Warning: Payment saved locally but could not sync to admin. The submission might not have been sent to Firebase yet.', '‚ö†Ô∏è');
                }
            } catch (error) {
                console.error('‚ùå Firebase sync error:', error);
                await customAlert('‚ö†Ô∏è Payment saved locally but sync failed: ' + error.message, '‚ö†Ô∏è');
            }
            
            // Update UI
            renderSubmissionHistory();
            closePaymentModal();
            
            // Show success message
            if (submission.paymentStatus === 'fully_paid') {
                await customAlert('üéâ Payment added! This job is now FULLY PAID!', 'üéâ');
            } else {
                const newRemaining = totalAmount - submission.totalPaid;
                await customAlert('‚úÖ Payment of ' + amount.toFixed(2) + ' MAD added!\nRemaining: ' + newRemaining.toFixed(2) + ' MAD', '‚úÖ');
            }
        }

        async function findFirebaseKeyByTimestamp(timestamp) {
            const data = loadData();
            const submission = data.submissions.find(s => s.timestamp === timestamp);
            
            // If we already have the firebaseKey locally, return it
            if (submission && submission.firebaseKey) {
                console.log('üîë Finding Firebase key for timestamp:', timestamp, '‚Üí', submission.firebaseKey, '(from localStorage)');
                return submission.firebaseKey;
            }
            
            // If not, search Firebase for it
            console.log('üîç Firebase key not in localStorage, searching Firebase...');
            try {
                const submissionsRef = window.firebaseRef(window.firebaseDB, 'submissions_v2');
                const snapshot = await window.firebaseGet(submissionsRef);
                
                if (snapshot.exists()) {
                    const allSubmissions = snapshot.val();
                    for (const [key, sub] of Object.entries(allSubmissions)) {
                        if (sub.timestamp === timestamp) {
                            console.log('‚úÖ Found Firebase key:', key);
                            
                            // Save it to localStorage for future use
                            if (submission) {
                                submission.firebaseKey = key;
                                saveData(data);
                                console.log('üíæ Saved Firebase key to localStorage');
                            }
                            
                            return key;
                        }
                    }
                }
                
                console.log('‚ùå No matching submission found in Firebase');
                return null;
            } catch (error) {
                console.error('‚ùå Error searching Firebase:', error);
                return null;
            }
        }

        // ========================================
        // ‚úèÔ∏è EDIT SESSION FEATURE (FEATURE 1)
        // ========================================
        
        let currentEditIndex = null;

        function editHistory(index) {
            const data = loadData();
            const session = data.history[index];
            
            if (!session) {
                return;
            }
            
            // Check if already sent
            if (session.sent === true) {
                customAlert('‚ö†Ô∏è Cannot edit: This session has already been submitted to admin.', '‚ö†Ô∏è');
                return;
            }
            
            currentEditIndex = index;
            
            // Populate modal with current values
            document.getElementById('edit-job-site').value = session.jobSite || session.job || '';
            document.getElementById('edit-client-name').value = session.clientName || session.job || '';
            document.getElementById('edit-hourly-rate').value = session.rate || '';
            
            // Convert ISO timestamps to HH:MM format
            const startDate = new Date(session.startTime);
            const endDate = new Date(session.endTime);
            
            if (timeFormat === '12h') {
                // 12-hour format with AM/PM
                const startResult = formatTimeTo12Hour(startDate);
                const endResult = formatTimeTo12Hour(endDate);
                
                document.getElementById('edit-start-time').value = startResult.time;
                document.getElementById('edit-start-period').value = startResult.period;
                
                document.getElementById('edit-stop-time').value = endResult.time;
                document.getElementById('edit-stop-period').value = endResult.period;
            } else {
                // 24-hour format
                document.getElementById('edit-start-time').value = formatTimeToHHMM(startDate);
                document.getElementById('edit-stop-time').value = formatTimeToHHMM(endDate);
            }
            
            // Show calculated result
            document.getElementById('edit-duration-display').textContent = formatHM(session.duration);
            document.getElementById('edit-payment-display').textContent = session.payment + ' MAD';
            document.getElementById('edit-calculated-result').style.display = 'block';
            
            // Show modal
            document.getElementById('editSessionModal').style.display = 'flex';
            
            // Add auto-calculation on input change
            setupEditAutoCalculation();
        }

        function formatTimeToHHMM(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return hours + ':' + minutes;
        }

        function formatTimeTo12Hour(date) {
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const period = hours >= 12 ? 'PM' : 'AM';
            
            // Convert to 12-hour format
            if (hours === 0) {
                hours = 12;
            } else if (hours > 12) {
                hours = hours - 12;
            }
            
            const time = String(hours).padStart(2, '0') + ':' + minutes;
            return { time, period };
        }

        function setupEditAutoCalculation() {
            const inputs = ['edit-job-site', 'edit-client-name', 'edit-hourly-rate', 'edit-start-time', 'edit-stop-time'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.removeEventListener('input', recalculateEditSession); // Prevent duplicates
                el.addEventListener('input', recalculateEditSession);
            });
            
            // Also listen to AM/PM dropdowns
            const editStartPeriod = document.getElementById('edit-start-period');
            const editStopPeriod = document.getElementById('edit-stop-period');
            
            if (editStartPeriod) {
                editStartPeriod.removeEventListener('change', recalculateEditSession);
                editStartPeriod.addEventListener('change', recalculateEditSession);
            }
            
            if (editStopPeriod) {
                editStopPeriod.removeEventListener('change', recalculateEditSession);
                editStopPeriod.addEventListener('change', recalculateEditSession);
            }
        }

        function recalculateEditSession() {
            const jobSite = document.getElementById('edit-job-site').value.trim();
            const clientName = document.getElementById('edit-client-name').value.trim();
            const rate = parseFloat(document.getElementById('edit-hourly-rate').value);
            let startTime = document.getElementById('edit-start-time').value.trim();
            let stopTime = document.getElementById('edit-stop-time').value.trim();
            
            if (!jobSite || !clientName || !rate || !startTime || !stopTime) {
                return;
            }
            
            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                const startPeriod = document.getElementById('edit-start-period').value;
                const stopPeriod = document.getElementById('edit-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }
            
            // Validate time format
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(startTime) || !timeRegex.test(stopTime)) {
                return;
            }
            
            // Get the original session's date
            const data = loadData();
            const originalSession = data.history[currentEditIndex];
            const originalDate = new Date(originalSession.endTime);
            const year = originalDate.getFullYear();
            const month = String(originalDate.getMonth() + 1).padStart(2, '0');
            const day = String(originalDate.getDate()).padStart(2, '0');
            const dateString = year + '-' + month + '-' + day;
            
            // Combine date with new times
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);
            
            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }
            
            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);
            
            // Update display
            document.getElementById('edit-duration-display').textContent = formatHM(durationSeconds);
            document.getElementById('edit-payment-display').textContent = payment + ' MAD';
            document.getElementById('edit-calculated-result').style.display = 'block';
        }

        async function saveEditedSession() {
            if (currentEditIndex === null) {
                return;
            }
            
            const jobSite = document.getElementById('edit-job-site').value.trim();
            const clientName = document.getElementById('edit-client-name').value.trim();
            const rate = parseFloat(document.getElementById('edit-hourly-rate').value);
            let startTime = document.getElementById('edit-start-time').value.trim();
            let stopTime = document.getElementById('edit-stop-time').value.trim();
            
            if (!jobSite || !clientName || !rate || !startTime || !stopTime) {
                await customAlert('‚ö†Ô∏è Please fill all fields!', '‚ö†Ô∏è');
                return;
            }
            
            // If 12-hour format, convert based on AM/PM selection
            if (timeFormat === '12h') {
                const startPeriod = document.getElementById('edit-start-period').value;
                const stopPeriod = document.getElementById('edit-stop-period').value;
                
                startTime = convertTo24Hour(startTime, startPeriod);
                stopTime = convertTo24Hour(stopTime, stopPeriod);
            }
            
            // Validate time format
            const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(startTime) || !timeRegex.test(stopTime)) {
                await customAlert('‚ö†Ô∏è Invalid time format. Use HH:MM format', '‚ö†Ô∏è');
                return;
            }
            
            const data = loadData();
            const originalSession = data.history[currentEditIndex];
            
            // Get the original session's date
            const originalDate = new Date(originalSession.endTime);
            const year = originalDate.getFullYear();
            const month = String(originalDate.getMonth() + 1).padStart(2, '0');
            const day = String(originalDate.getDate()).padStart(2, '0');
            const dateString = year + '-' + month + '-' + day;
            
            // Combine date with new times
            const start = new Date(dateString + 'T' + startTime);
            let stop = new Date(dateString + 'T' + stopTime);
            
            // If stop time is before start time, assume it's next day
            if (stop <= start) {
                stop.setDate(stop.getDate() + 1);
            }
            
            const durationSeconds = Math.floor((stop - start) / 1000);
            const payment = calculatePayment(durationSeconds, rate);
            
            // Update session (preserve timestamp if it exists)
            const originalTimestamp = originalSession.timestamp || Date.now();
            data.history[currentEditIndex] = {
                timestamp: originalTimestamp,
                jobSite: jobSite,
                clientName: clientName,
                rate: rate,
                startTime: start.toISOString(),
                endTime: stop.toISOString(),
                duration: durationSeconds,
                payment: payment,
                sent: false // Keep as unsent
            };
            
            saveData(data);
            
            // Sync edited session to Firebase
            await window.saveDraftToFirebase(data.history[currentEditIndex]);
            
            // Update UI
            renderHistory();
            updateTodaySummary();
            updateTotalSummary();
            updateSubmitSummary();
            
            // Close modal
            closeEditSessionModal();
            
            await customAlert('‚úÖ Session updated successfully!', '‚úÖ');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').style.display = 'none';
            currentEditIndex = null;
        }

        // Auto-format time inputs in edit modal
        document.getElementById('edit-start-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        document.getElementById('edit-stop-time').addEventListener('input', function() {
            formatTimeInput(this);
        });

        // ========================================
        // üïê TIME FORMAT FEATURE (FEATURE 2)
        // ========================================
        
        // timeFormat is now declared at the top of the script (line 1324)

        function setTimeFormat(format) {
            console.error('üîò setTimeFormat CALLED! Format:', format);
            timeFormat = format;
            localStorage.setItem('timeFormat', format);
            
            // Update button styles
            const btn24h = document.getElementById('time-format-24h');
            const btn12h = document.getElementById('time-format-12h');
            
            if (format === '24h') {
                btn24h.style.background = '#2563eb';
                btn24h.style.color = 'white';
                btn24h.style.borderColor = '#2563eb';
                
                btn12h.style.background = 'white';
                btn12h.style.color = '#64748b';
                btn12h.style.borderColor = '#e2e8f0';
            } else {
                btn12h.style.background = '#2563eb';
                btn12h.style.color = 'white';
                btn12h.style.borderColor = '#2563eb';
                
                btn24h.style.background = 'white';
                btn24h.style.color = '#64748b';
                btn24h.style.borderColor = '#e2e8f0';
            }
            
            // Show/hide AM/PM dropdowns
            toggleAmPmDropdowns(format === '12h');
            
            // Re-render all time displays
            renderHistory();
            renderSubmissionHistory();
            
            console.log('üïê Time format changed to:', format);
        }

        function toggleAmPmDropdowns(show) {
            // Manual Entry dropdowns
            const manualStartPeriod = document.getElementById('manual-start-period');
            const manualStopPeriod = document.getElementById('manual-stop-period');
            
            // Edit Session dropdowns
            const editStartPeriod = document.getElementById('edit-start-period');
            const editStopPeriod = document.getElementById('edit-stop-period');
            
            const displayValue = show ? 'block' : 'none';
            
            if (manualStartPeriod) manualStartPeriod.style.display = displayValue;
            if (manualStopPeriod) manualStopPeriod.style.display = displayValue;
            if (editStartPeriod) editStartPeriod.style.display = displayValue;
            if (editStopPeriod) editStopPeriod.style.display = displayValue;
        }

        function formatTimeDisplay(isoString) {
            const date = new Date(isoString);
            
            if (timeFormat === '12h') {
                // 12-hour format with AM/PM
                return date.toLocaleTimeString(currentLang === 'ar' ? 'ar-SA' : 'en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            } else {
                // 24-hour format
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return hours + ':' + minutes;
            }
        }

        // Initialize time format on page load
        function initializeTimeFormat() {
            setTimeFormat(timeFormat);
        }

        // ========================================
        // üí∞ PRICE ADJUSTMENT FEATURE (FEATURE 3)
        // ========================================
        
        let currentPriceAdjustIndex = null;

        function showPriceAdjustModal(index) {
            const data = loadData();
            const session = data.history[index];
            
            if (!session) {
                return;
            }
            
            currentPriceAdjustIndex = index;
            
            const clientName = session.clientName || session.job || 'Unknown';
            const jobSite = session.jobSite || session.job || 'Unknown';
            const originalPrice = parseFloat(session.payment);
            const currentPrice = session.adjustedPrice !== undefined ? parseFloat(session.adjustedPrice) : originalPrice;
            
            // Populate modal
            document.getElementById('priceAdjustInfo').innerHTML = 
                '<div style="font-weight: 600; margin-bottom: 8px;">üë§ ' + clientName + '</div>' +
                '<div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">üìç ' + jobSite + '</div>' +
                '<div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">' + formatHM(session.duration) + '</div>' +
                '<div style="border-top: 1px solid #e2e8f0; margin-top: 10px; padding-top: 10px;">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">' +
                '<strong>' + t('original_price') + '</strong>' +
                '<span style="color: #64748b;">' + originalPrice.toFixed(2) + ' MAD</span></div>' +
                (session.adjustedPrice !== undefined ? 
                    '<div style="display: flex; justify-content: space-between;">' +
                    '<strong>' + t('adjusted_price') + '</strong>' +
                    '<span style="color: #f59e0b; font-weight: 600;">' + currentPrice.toFixed(2) + ' MAD</span></div>' 
                    : '') +
                '</div>';
            
            document.getElementById('adjustedPriceInput').value = currentPrice.toFixed(2);
            document.getElementById('priceAdjustModal').style.display = 'flex';
        }

        function closePriceAdjustModal() {
            document.getElementById('priceAdjustModal').style.display = 'none';
            currentPriceAdjustIndex = null;
        }

        async function applyPriceAdjustment() {
            if (currentPriceAdjustIndex === null) {
                return;
            }
            
            const newPrice = parseFloat(document.getElementById('adjustedPriceInput').value);
            
            if (!newPrice || newPrice < 0) {
                await customAlert('‚ö†Ô∏è Please enter a valid price!', '‚ö†Ô∏è');
                return;
            }
            
            const data = loadData();
            const session = data.history[currentPriceAdjustIndex];
            const originalPrice = parseFloat(session.payment);
            
            // Apply the adjusted price
            data.history[currentPriceAdjustIndex].adjustedPrice = newPrice.toFixed(2);
            
            saveData(data);
            updateSubmitSummary();
            closePriceAdjustModal();
            
            const diff = newPrice - originalPrice;
            const diffText = diff >= 0 ? '+' + diff.toFixed(2) : diff.toFixed(2);
            
            await customAlert('‚úÖ Price adjusted!\n\nOriginal: ' + originalPrice.toFixed(2) + ' MAD\nNew: ' + newPrice.toFixed(2) + ' MAD\nDifference: ' + diffText + ' MAD', '‚úÖ');
        }

        async function resetPrice() {
            if (currentPriceAdjustIndex === null) {
                return;
            }
            
            const data = loadData();
            const session = data.history[currentPriceAdjustIndex];
            const originalPrice = parseFloat(session.payment);
            
            // Remove adjusted price (reset to original)
            delete data.history[currentPriceAdjustIndex].adjustedPrice;
            
            saveData(data);
            updateSubmitSummary();
            closePriceAdjustModal();
            
            await customAlert('‚úÖ Price reset to original: ' + originalPrice.toFixed(2) + ' MAD', '‚úÖ');
        }
        
        // ========================================
        // üí∞ EXPENSES SYSTEM
        // ========================================
        
        let currentExpenseFilter = 'today';
        let editingExpenseId = null;
        
        // Open expense modal
        function openExpenseModal(type) {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            
            if (type === 'repair') {
                document.getElementById('repair-date').value = today;
                document.getElementById('repair-amount').value = '';
                document.getElementById('repair-description').value = '';
                document.getElementById('repairModal').style.display = 'flex';
            } else if (type === 'fuel') {
                document.getElementById('fuel-date').value = today;
                document.getElementById('fuel-total-amount').value = '';
                document.getElementById('fuel-liters').value = '';
                document.getElementById('fuel-price-per-liter').value = '';
                document.getElementById('fuel-description').value = '';
                lastFuelFieldEdited = null;
                document.getElementById('fuelModal').style.display = 'flex';
            } else if (type === 'parts') {
                document.getElementById('parts-date').value = today;
                document.getElementById('parts-name').value = '';
                document.getElementById('parts-price').value = '';
                document.getElementById('parts-notes').value = '';
                document.getElementById('partsModal').style.display = 'flex';
            }
        }
        
        // Close expense modal
        function closeExpenseModal() {
            document.getElementById('repairModal').style.display = 'none';
            document.getElementById('fuelModal').style.display = 'none';
            document.getElementById('partsModal').style.display = 'none';
            document.getElementById('editExpenseModal').style.display = 'none';
            editingExpenseId = null;
        }
        
        // Calculate fuel total
        // Bi-directional fuel calculation
        let lastFuelFieldEdited = null;
        
        function calculateFuelFromTotal() {
            lastFuelFieldEdited = 'total';
            const totalAmount = parseFloat(document.getElementById('fuel-total-amount').value) || 0;
            const liters = parseFloat(document.getElementById('fuel-liters').value) || 0;
            
            if (liters > 0) {
                const pricePerLiter = totalAmount / liters;
                document.getElementById('fuel-price-per-liter').value = pricePerLiter.toFixed(2);
            }
        }
        
        function calculateFuelFromPrice() {
            lastFuelFieldEdited = 'price';
            const pricePerLiter = parseFloat(document.getElementById('fuel-price-per-liter').value) || 0;
            const liters = parseFloat(document.getElementById('fuel-liters').value) || 0;
            
            const total = pricePerLiter * liters;
            document.getElementById('fuel-total-amount').value = total.toFixed(2);
        }
        
        function calculateFuelBidirectional() {
            // When liters change, update based on last edited field
            if (lastFuelFieldEdited === 'total') {
                calculateFuelFromTotal();
            } else {
                calculateFuelFromPrice();
            }
        }
        
        // Save expense
        async function saveExpense(type) {
            const data = loadData();
            
            if (!data.expenses) {
                data.expenses = {
                    unsent: [],
                    submitted: []
                };
            }
            
            let expense = {
                id: Date.now(),
                type: type,
                timestamp: Date.now(),
                sent: false
            };
            
            if (type === 'repair') {
                const date = document.getElementById('repair-date').value;
                const amount = parseFloat(document.getElementById('repair-amount').value);
                const description = document.getElementById('repair-description').value;
                
                if (!date || !amount || amount <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in all required fields!', '‚ö†Ô∏è');
                    return;
                }
                
                expense.date = date;
                expense.amount = amount;
                expense.description = description;
                
            } else if (type === 'fuel') {
                const date = document.getElementById('fuel-date').value;
                const totalAmount = parseFloat(document.getElementById('fuel-total-amount').value);
                const liters = parseFloat(document.getElementById('fuel-liters').value);
                const pricePerLiter = parseFloat(document.getElementById('fuel-price-per-liter').value);
                const description = document.getElementById('fuel-description').value;
                
                // Validate: need at least total+liters OR price+liters
                if (!date || !liters || liters <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in date and liters!', '‚ö†Ô∏è');
                    return;
                }
                
                if (!totalAmount && !pricePerLiter) {
                    await customAlert('‚ö†Ô∏è Please fill in either Total Amount or Price per Liter!', '‚ö†Ô∏è');
                    return;
                }
                
                // Use whichever calculation was done
                const finalAmount = totalAmount || (pricePerLiter * liters);
                const finalPricePerLiter = pricePerLiter || (totalAmount / liters);
                
                expense.date = date;
                expense.pricePerLiter = finalPricePerLiter;
                expense.liters = liters;
                expense.amount = finalAmount;
                expense.description = description;
                
            } else if (type === 'parts') {
                const date = document.getElementById('parts-date').value;
                const partName = document.getElementById('parts-name').value;
                const price = parseFloat(document.getElementById('parts-price').value);
                const notes = document.getElementById('parts-notes').value;
                
                if (!date || !partName || !price || price <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in all required fields!', '‚ö†Ô∏è');
                    return;
                }
                
                expense.date = date;
                expense.partName = partName;
                expense.amount = price;
                expense.notes = notes;
            }
            
            data.expenses.unsent.push(expense);
            saveData(data);
            closeExpenseModal();
            renderExpenses();
            await customAlert('‚úÖ Expense saved successfully!', '‚úÖ');
            
            // Sync to Firebase
            await syncExpensesToFirebase();
        }
        
        // Render expenses
        function renderExpenses() {
            const data = loadData();
            
            if (!data.expenses) {
                data.expenses = {
                    unsent: [],
                    submitted: []
                };
                saveData(data);
            }
            
            // Render unsent expenses
            renderUnsentExpenses(data.expenses.unsent);
            
            // Render submitted expenses
            renderSubmittedExpenses(data.expenses.submitted);
            
            // Update summary cards
            updateExpensesSummary(data.expenses);
        }
        
        // Render unsent expenses
        function renderUnsentExpenses(unsentExpenses) {
            const container = document.getElementById('unsent-expenses-list');
            const badge = document.getElementById('unsent-count-badge');
            const submitBtn = document.getElementById('submit-expenses-btn');
            
            badge.textContent = unsentExpenses.length;
            
            if (unsentExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #92400e; font-size: 13px;" data-i18n="exp_no_unsent">No unsent expenses</p>';
                submitBtn.style.display = 'none';
                applyLanguage();
                return;
            }
            
            submitBtn.style.display = 'block';
            
            container.innerHTML = unsentExpenses.map(exp => {
                const date = formatDate(new Date(exp.date));
                let icon, title, details;
                
                if (exp.type === 'repair') {
                    icon = 'üîß';
                    title = t('exp_repair');
                    details = exp.description;
                } else if (exp.type === 'fuel') {
                    icon = '‚õΩ';
                    title = t('exp_fuel');
                    details = `${exp.liters}L √ó ${exp.pricePerLiter} MAD`;
                } else if (exp.type === 'parts') {
                    icon = '‚öôÔ∏è';
                    title = t('exp_parts');
                    details = exp.partName;
                }
                
                return `
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 3px;">
                                    ${icon} ${title}
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 3px;">${details}</div>
                                ${exp.type === 'parts' && exp.notes ? `<div style="font-size: 11px; color: #6b7280; margin-bottom: 3px;">üìù ${exp.notes}</div>` : ''}
                                <div style="font-size: 11px; color: #94a3b8;">üìÖ ${date}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">
                                    ${exp.amount.toFixed(2)} MAD
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="editExpense(${exp.id})" style="padding: 4px 10px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; color: #2563eb;">
                                        ‚úèÔ∏è ${t('edit')}
                                    </button>
                                    <button onclick="deleteExpense(${exp.id})" style="padding: 4px 10px; border: 1px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; color: #ef4444;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Edit expense
        async function editExpense(expenseId) {
            const data = loadData();
            const expense = data.expenses.unsent.find(e => e.id === expenseId);
            
            if (!expense) return;
            
            editingExpenseId = expenseId;
            
            // Build edit form based on expense type
            let formHTML = '';
            
            if (expense.type === 'repair') {
                formHTML = `
                    <div class="input-group">
                        <label>${t('exp_date')}</label>
                        <input type="date" id="edit-repair-date" value="${expense.date}" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_amount')}</label>
                        <input type="number" id="edit-repair-amount" value="${expense.amount}" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_description')}</label>
                        <textarea id="edit-repair-description" rows="3" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;">${expense.description}</textarea>
                    </div>
                `;
            } else if (expense.type === 'fuel') {
                formHTML = `
                    <div class="input-group">
                        <label>${t('exp_date')}</label>
                        <input type="date" id="edit-fuel-date" value="${expense.date}" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_total_amount')}</label>
                        <input type="number" id="edit-fuel-total" value="${expense.amount}" step="0.01" min="0" oninput="calculateEditFuelFromTotal()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_liters')}</label>
                        <input type="number" id="edit-fuel-liters" value="${expense.liters}" step="0.1" min="0" oninput="calculateEditFuelBidirectional()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_price_per_liter')}</label>
                        <input type="number" id="edit-fuel-price" value="${expense.pricePerLiter}" step="0.01" min="0" oninput="calculateEditFuelFromPrice()" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_description')}</label>
                        <textarea id="edit-fuel-description" rows="2" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;">${expense.description || ''}</textarea>
                    </div>
                `;
            } else if (expense.type === 'parts') {
                formHTML = `
                    <div class="input-group">
                        <label>${t('exp_date')}</label>
                        <input type="date" id="edit-parts-date" value="${expense.date}" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_part_name')}</label>
                        <input type="text" id="edit-parts-name" value="${expense.partName}" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_price')}</label>
                        <input type="number" id="edit-parts-price" value="${expense.amount}" step="0.01" min="0" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="input-group">
                        <label>${t('exp_notes')}</label>
                        <textarea id="edit-parts-notes" rows="2" style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; resize: vertical;">${expense.notes || ''}</textarea>
                    </div>
                `;
            }
            
            formHTML += `
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeExpenseModal()" style="flex: 1; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: white; color: #64748b;">${t('cancel')}</button>
                    <button onclick="saveEditedExpense()" style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; background: #10b981; color: white;">${t('save_changes')}</button>
                </div>
            `;
            
            document.getElementById('editExpenseContent').innerHTML = formHTML;
            document.getElementById('editExpenseModal').style.display = 'flex';
        }
        
        // Calculate edit fuel - bi-directional
        let lastEditFuelFieldEdited = null;
        
        function calculateEditFuelFromTotal() {
            lastEditFuelFieldEdited = 'total';
            const totalAmount = parseFloat(document.getElementById('edit-fuel-total').value) || 0;
            const liters = parseFloat(document.getElementById('edit-fuel-liters').value) || 0;
            
            if (liters > 0) {
                const pricePerLiter = totalAmount / liters;
                document.getElementById('edit-fuel-price').value = pricePerLiter.toFixed(2);
            }
        }
        
        function calculateEditFuelFromPrice() {
            lastEditFuelFieldEdited = 'price';
            const pricePerLiter = parseFloat(document.getElementById('edit-fuel-price').value) || 0;
            const liters = parseFloat(document.getElementById('edit-fuel-liters').value) || 0;
            
            const total = pricePerLiter * liters;
            document.getElementById('edit-fuel-total').value = total.toFixed(2);
        }
        
        function calculateEditFuelBidirectional() {
            if (lastEditFuelFieldEdited === 'total') {
                calculateEditFuelFromTotal();
            } else {
                calculateEditFuelFromPrice();
            }
        }
        
        // Save edited expense
        async function saveEditedExpense() {
            const data = loadData();
            const expenseIndex = data.expenses.unsent.findIndex(e => e.id === editingExpenseId);
            
            if (expenseIndex === -1) return;
            
            const expense = data.expenses.unsent[expenseIndex];
            
            if (expense.type === 'repair') {
                const date = document.getElementById('edit-repair-date').value;
                const amount = parseFloat(document.getElementById('edit-repair-amount').value);
                const description = document.getElementById('edit-repair-description').value;
                
                if (!date || !amount || amount <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in all required fields!', '‚ö†Ô∏è');
                    return;
                }
                
                data.expenses.unsent[expenseIndex].date = date;
                data.expenses.unsent[expenseIndex].amount = amount;
                data.expenses.unsent[expenseIndex].description = description;
                
            } else if (expense.type === 'fuel') {
                const date = document.getElementById('edit-fuel-date').value;
                const totalAmount = parseFloat(document.getElementById('edit-fuel-total').value);
                const liters = parseFloat(document.getElementById('edit-fuel-liters').value);
                const pricePerLiter = parseFloat(document.getElementById('edit-fuel-price').value);
                const description = document.getElementById('edit-fuel-description').value;
                
                // Validate: need at least total+liters OR price+liters
                if (!date || !liters || liters <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in date and liters!', '‚ö†Ô∏è');
                    return;
                }
                
                if (!totalAmount && !pricePerLiter) {
                    await customAlert('‚ö†Ô∏è Please fill in either Total Amount or Price per Liter!', '‚ö†Ô∏è');
                    return;
                }
                
                // Use whichever calculation was done
                const finalAmount = totalAmount || (pricePerLiter * liters);
                const finalPricePerLiter = pricePerLiter || (totalAmount / liters);
                
                data.expenses.unsent[expenseIndex].date = date;
                data.expenses.unsent[expenseIndex].pricePerLiter = finalPricePerLiter;
                data.expenses.unsent[expenseIndex].liters = liters;
                data.expenses.unsent[expenseIndex].amount = finalAmount;
                data.expenses.unsent[expenseIndex].description = description;
                
            } else if (expense.type === 'parts') {
                const date = document.getElementById('edit-parts-date').value;
                const partName = document.getElementById('edit-parts-name').value;
                const price = parseFloat(document.getElementById('edit-parts-price').value);
                const notes = document.getElementById('edit-parts-notes').value;
                
                if (!date || !partName || !price || price <= 0) {
                    await customAlert('‚ö†Ô∏è Please fill in all required fields!', '‚ö†Ô∏è');
                    return;
                }
                
                data.expenses.unsent[expenseIndex].date = date;
                data.expenses.unsent[expenseIndex].partName = partName;
                data.expenses.unsent[expenseIndex].amount = price;
                data.expenses.unsent[expenseIndex].notes = notes;
            }
            
            saveData(data);
            closeExpenseModal();
            renderExpenses();
            await customAlert('‚úÖ Expense updated successfully!', '‚úÖ');
            
            // Sync to Firebase
            await syncExpensesToFirebase();
        }
        
        // Delete expense
        async function deleteExpense(expenseId) {
            const confirmed = await customConfirm('üóëÔ∏è Delete this expense?', '‚ö†Ô∏è');
            if (!confirmed) return;
            
            const data = loadData();
            data.expenses.unsent = data.expenses.unsent.filter(e => e.id !== expenseId);
            saveData(data);
            renderExpenses();
            await customAlert('‚úÖ Expense deleted!', '‚úÖ');
            
            // Sync to Firebase
            await syncExpensesToFirebase();
        }
        
        // Submit expenses
        async function submitExpenses() {
            const data = loadData();
            const workerName = data.workerName;
            
            // Check if worker name is set
            if (!workerName || workerName.trim() === '') {
                await customAlert('‚ö†Ô∏è Please set your name in Settings tab before submitting expenses!', '‚ö†Ô∏è');
                return;
            }
            
            if (!data.expenses || data.expenses.unsent.length === 0) {
                await customAlert('‚ö†Ô∏è No unsent expenses to submit!', '‚ö†Ô∏è');
                return;
            }
            
            const confirmed = await customConfirm(`üì§ Submit ${data.expenses.unsent.length} expense(s) to admin?`, 'üí∞');
            if (!confirmed) return;
            
            // Calculate total
            const totalAmount = data.expenses.unsent.reduce((sum, exp) => sum + exp.amount, 0);
            
            // Create submission
            const submission = {
                workerName: workerName,
                timestamp: Date.now(),
                date: new Date().toISOString(),
                expenses: data.expenses.unsent.map(exp => ({...exp})),
                totalAmount: totalAmount,
                status: 'pending'
            };
            
            // Add to submitted
            data.expenses.submitted.push(submission);
            
            // Clear unsent
            data.expenses.unsent = [];
            
            saveData(data);
            renderExpenses();
            
            // Sync to Firebase
            await submitExpensesToFirebase(submission);
            
            await customAlert(`‚úÖ Expenses submitted successfully!\n\nTotal: ${totalAmount.toFixed(2)} MAD`, '‚úÖ');
        }
        
        // Render submitted expenses
        function renderSubmittedExpenses(submittedExpenses) {
            const container = document.getElementById('submitted-expenses-list');
            
            // Filter by current filter
            const filtered = filterExpensesByPeriod(submittedExpenses, currentExpenseFilter);
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;" data-i18n="exp_no_submitted">No submitted expenses yet</p>';
                applyLanguage();
                return;
            }
            
            // Sort by most recent
            const sorted = [...filtered].sort((a, b) => b.timestamp - a.timestamp);
            
            container.innerHTML = sorted.map(submission => {
                const date = formatDate(new Date(submission.date || submission.timestamp));
                const time = new Date(submission.date || submission.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                
                let statusBadge;
                if (submission.status === 'approved') {
                    statusBadge = '<span style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚úÖ ' + t('exp_approved') + '</span>';
                } else if (submission.status === 'rejected') {
                    statusBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚ùå ' + t('exp_rejected') + '</span>';
                } else {
                    statusBadge = '<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚è≥ ' + t('exp_pending') + '</span>';
                }
                
                const expensesList = submission.expenses.map(exp => {
                    let icon, title, details;
                    
                    if (exp.type === 'repair') {
                        icon = 'üîß';
                        title = t('exp_repair');
                        details = exp.description;
                    } else if (exp.type === 'fuel') {
                        icon = '‚õΩ';
                        title = t('exp_fuel');
                        details = `${exp.liters}L √ó ${exp.pricePerLiter} MAD`;
                    } else if (exp.type === 'parts') {
                        icon = '‚öôÔ∏è';
                        title = t('exp_parts');
                        details = exp.partName;
                    }
                    
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px; margin-bottom: 5px;">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600; color: #1e293b;">${icon} ${title}</div>
                                <div style="font-size: 11px; color: #64748b;">${details}</div>
                                ${exp.type === 'parts' && exp.notes ? `<div style="font-size: 10px; color: #6b7280; margin-top: 2px;">üìù ${exp.notes}</div>` : ''}
                            </div>
                            <div style="font-size: 14px; font-weight: 700; color: #dc2626;">
                                ${exp.amount.toFixed(2)} MAD
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #2563eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 11px; color: #64748b;">üìÖ ${date} ${time}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            ${expensesList}
                        </div>
                        
                        <div style="text-align: right; padding-top: 10px; border-top: 2px solid #e2e8f0;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 3px;">${t('exp_total_amount')}</div>
                            <div style="font-size: 20px; font-weight: 700; color: #dc2626;">
                                ${submission.totalAmount.toFixed(2)} MAD
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter expenses by period
        function filterExpensesByPeriod(expenses, period) {
            const now = new Date();
            
            if (period === 'today') {
                const today = now.toDateString();
                return expenses.filter(exp => new Date(exp.date).toDateString() === today);
            } else if (period === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                return expenses.filter(exp => new Date(exp.date) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                return expenses.filter(exp => new Date(exp.date) >= monthAgo);
            } else {
                return expenses;
            }
        }
        
        // Filter submitted expenses
        function filterSubmittedExpenses(period) {
            currentExpenseFilter = period;
            
            // Update filter buttons
            document.querySelectorAll('.expense-filter-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#64748b';
                btn.style.borderColor = '#e2e8f0';
            });
            
            event.target.style.background = '#2563eb';
            event.target.style.color = 'white';
            event.target.style.borderColor = '#2563eb';
            
            const data = loadData();
            if (!data.expenses) {
                data.expenses = { unsent: [], submitted: [] };
                saveData(data);
            }
            
            renderSubmittedExpenses(data.expenses.submitted);
        }
        
        // Update expenses summary cards
        function updateExpensesSummary(expenses) {
            const now = new Date();
            const today = now.toDateString();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Combine unsent and submitted expenses for summary
            const allExpenses = [
                ...expenses.unsent.map(e => ({...e, date: e.date})),
                ...expenses.submitted.flatMap(s => s.expenses.map(e => ({...e, date: e.date})))
            ];
            
            // Calculate totals
            const todayTotal = allExpenses
                .filter(exp => new Date(exp.date).toDateString() === today)
                .reduce((sum, exp) => sum + exp.amount, 0);
                
            const weekTotal = allExpenses
                .filter(exp => new Date(exp.date) >= weekAgo)
                .reduce((sum, exp) => sum + exp.amount, 0);
                
            const monthTotal = allExpenses
                .filter(exp => new Date(exp.date) >= monthAgo)
                .reduce((sum, exp) => sum + exp.amount, 0);
            
            document.getElementById('expenses-today').textContent = todayTotal.toFixed(2) + ' MAD';
            document.getElementById('expenses-week').textContent = weekTotal.toFixed(2) + ' MAD';
            document.getElementById('expenses-month').textContent = monthTotal.toFixed(2) + ' MAD';
        }
        
        // Sync expenses to Firebase
        async function syncExpensesToFirebase() {
            try {
                const data = loadData();
                const workerName = data.workerName || 'Unknown Worker';
                
                if (!data.expenses) return;
                
                // Sync unsent expenses to Firebase drafts
                const expensesRef = window.firebaseRef(window.firebaseDB, 'expensesDrafts_v2/' + workerName);
                await window.firebaseSet(expensesRef, data.expenses.unsent);
                
                console.log('‚úÖ Expenses synced to Firebase');
            } catch (error) {
                console.error('‚ùå Error syncing expenses to Firebase:', error);
            }
        }
        
        // Submit expenses to Firebase
        async function submitExpensesToFirebase(submission) {
            try {
                // Push to expenseSubmissions in Firebase
                const submissionsRef = window.firebaseRef(window.firebaseDB, 'expenseSubmissions_v2');
                const newSubmissionRef = window.firebasePush ? window.firebasePush(submissionsRef) : window.firebaseRef(window.firebaseDB, 'expenseSubmissions_v2/' + submission.timestamp);
                await window.firebaseSet(newSubmissionRef, submission);
                
                console.log('‚úÖ Expenses submitted to Firebase');
                
                // Clear drafts
                const data = loadData();
                const workerName = data.workerName || 'Unknown Worker';
                const expensesRef = window.firebaseRef(window.firebaseDB, 'expensesDrafts_v2/' + workerName);
                await window.firebaseSet(expensesRef, []);
            } catch (error) {
                console.error('‚ùå Error submitting expenses to Firebase:', error);
            }
        }
        
        // Load expense submissions from Firebase
        function loadExpenseSubmissionsFromFirebase() {
            try {
                const submissionsRef = window.firebaseRef(window.firebaseDB, 'expenseSubmissions_v2');
                
                window.firebaseOnValue(submissionsRef, (snapshot) => {
                    const data = loadData();
                    const workerName = data.workerName || 'Unknown Worker';
                    
                    // Initialize expenses structure if needed
                    if (!data.expenses) {
                        data.expenses = { unsent: [], submitted: [] };
                    }
                    
                    if (snapshot.exists()) {
                        const submissions = Object.values(snapshot.val());
                        
                        // Filter submissions for this worker and sync completely
                        // This replaces the entire submitted array, so deletions are reflected
                        const workerSubmissions = submissions.filter(s => s.workerName === workerName);
                        data.expenses.submitted = workerSubmissions;
                    } else {
                        // No submissions in Firebase, clear the submitted array
                        data.expenses.submitted = [];
                    }
                    
                    saveData(data);
                    renderExpenses();
                    
                    console.log('‚úÖ Expense submissions synced from Firebase');
                });
            } catch (error) {
                console.error('‚ùå Error loading expense submissions from Firebase:', error);
            }
        }
        
        // Make firebasePush available globally if not already
        if (!window.firebasePush) {
            import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js')
                .then(module => {
                    window.firebasePush = module.push;
                });
        }
        
        // ========================================
        // END EXPENSES SYSTEM
        // ========================================
        
        // Disable service worker during development to avoid caching issues
        // if ('serviceWorker' in navigator) {
        //     navigator.serviceWorker.register('sw.js').catch(function() {});
        // }
    </script>
</body>
</html>
